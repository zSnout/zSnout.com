var Dt=Object.defineProperty;var Pt=(r,t,e)=>t in r?Dt(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var et=(r,t,e)=>(Pt(r,typeof t!="symbol"?t+"":t,e),e);import{L as Ot,C as It,v as lt,Q as Gt}from"./index.3672xjxd.js";const gt=`
#ifdef GL_ES
precision mediump float;
#endif

attribute vec4 a_position;
attribute vec4 a_normal;
attribute vec2 a_texcoord;
attribute vec4 a_color;

varying vec4 v_position;
varying vec4 v_normal;
varying vec2 v_texcoord;
varying vec4 v_color;
`,ct=`
#ifdef GL_ES
precision mediump float;
#endif

varying vec4 v_position;
varying vec4 v_normal;
varying vec2 v_texcoord;
varying vec4 v_color;
`,Lt=`#version 300 es

precision mediump float;

in vec4 a_position;
in vec4 a_normal;
in vec2 a_texcoord;
in vec4 a_color;

out vec4 v_position;
out vec4 v_normal;
out vec2 v_texcoord;
out vec4 v_color;
`,ut=`#version 300 es

precision mediump float;

in vec4 v_position;
in vec4 v_normal;
in vec2 v_texcoord;
in vec4 v_color;

out vec4 outColor;
`,k=`
uniform mat4 u_projectionMatrix;
uniform mat4 u_modelViewMatrix;
uniform mat4 u_normalMatrix;

uniform vec2 u_resolution;
uniform float u_time;
`,Ft=`
void main() {
	v_position = a_position;
	v_normal = a_normal;
	v_texcoord = a_texcoord;
	v_color = a_color;
	gl_Position = a_position;
}
`,Ut=`
void main(void) {
	v_position = u_projectionMatrix * u_modelViewMatrix * a_position;
	v_normal = u_normalMatrix * a_normal;
	v_texcoord = a_texcoord;
	v_color = a_color;
	gl_Position = v_position;
}
`,Bt=`
void main() {
	vec2 st = gl_FragCoord.xy / u_resolution.xy;
	st.x *= u_resolution.x / u_resolution.y;
	vec3 color = vec3(
		abs(cos(u_time * 0.1)) * st.y,
		abs(cos(u_time * 0.2)) * st.y,
		abs(sin(u_time)) * st.y
	);
	gl_FragColor = vec4(color, 1.0);
}
`,Ct=`
void main() {
	vec2 st = gl_FragCoord.xy / u_resolution.xy;
	st.x *= u_resolution.x / u_resolution.y;
	vec3 color = vec3(
		abs(cos(u_time * 0.1)) * st.y,
		abs(cos(u_time * 0.2)) * st.y,
		abs(sin(u_time)) * st.y
	);
	outColor = vec4(color, 1.0);
}
`,Wt=`
void main() {
	vec2 uv = v_texcoord;
	vec3 color = vec3(
		abs(cos(u_time * 0.1)) * uv.y,
		abs(cos(u_time * 0.2)) * uv.y,
		abs(sin(u_time)) * uv.y
	);
	float incidence = max(dot(v_normal.xyz, vec3(0.0, 1.0, 0.0)), 0.0);
	vec3 light = vec3(0.2) + (vec3(1.0) * incidence);
	gl_FragColor = vec4(v_color.rgb * color * light, 1.0);
}
`,Vt=`
void main() {
	vec2 uv = v_texcoord;
	vec3 color = vec3(
		abs(cos(u_time * 0.1)) * uv.y,
		abs(cos(u_time * 0.2)) * uv.y,
		abs(sin(u_time)) * uv.y
	);
	float incidence = max(dot(v_normal.xyz, vec3(0.0, 1.0, 0.0)), 0.0);
	vec3 light = vec3(0.2) + (vec3(1.0) * incidence);
	outColor = vec4(v_color.rgb * color * light, 1.0);
}
`,Nt=`
void main(){
	gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
}`,zt=`
void main() {
	outColor = vec4(0.0, 0.0, 0.0, 1.0);
}
`,dt=gt+k+Ut,mt=Lt+k+Ut,kt=ct+k+Bt,Xt=ut+k+Ct,Ht=ct+k+Wt,jt=ut+k+Vt,Yt=gt+k+Ft,$t=Lt+k+Ft,qt=ct+k+Nt,Kt=ut+k+zt;class I{static fetch(t){return new Promise(function(e,i){const s=new XMLHttpRequest;s.onload=function(){e(s.response||s.responseText)},s.onerror=function(n){console.log("Common.error",n),i(new Error(`Network request failed for url ${t}`))},s.ontimeout=function(n){i(new Error(`Network request failed for url ${t}`))},s.onabort=function(){i(new Error("Aborted"))},s.open("GET",t,!0),s.send(null)})}static getResource(t,e=""){return t.indexOf(":/")===-1?I.join(e,t):t}static join(...t){let e=[];return t.forEach(i=>{i.indexOf("/")===0&&(e=[]),I.comps(i).forEach(n=>{switch(n){case".":break;case"..":e.pop();break;default:e.push(n)}})}),e.join("/")}static dirname(t){const e=I.comps(t);return e.pop(),e.join("/")}static comps(t){return t.replace(/\/$/,"").split(/\/+/)}}var J;(function(r){r[r.None=0]="None",r[r.Error=1]="Error",r[r.Warn=2]="Warn",r[r.Log=3]="Log"})(J||(J={}));class U{static log(...t){U.enabled&&U.level>=J.Log&&console.log(...t)}static warn(...t){U.enabled&&U.level>=J.Warn&&console.warn(...t)}static error(...t){U.enabled&&U.level>=J.Error&&console.error(...t)}}U.level=J.Warn;U.enabled=!0;var V;(function(r){r.WebGl="webgl",r.WebGl2="webgl2"})(V||(V={}));var at;(function(r){r.LowP="lowp",r.MediumP="mediump",r.HighP="highp"})(at||(at={}));var S;(function(r){r.Flat="flat",r.Box="box",r.Sphere="sphere",r.Torus="torus",r.Mesh="mesh"})(S||(S={}));const vt={webgl:{flat:{vertex:dt,fragment:kt},mesh:{vertex:dt,fragment:Ht}},webgl2:{flat:{vertex:mt,fragment:Xt},mesh:{vertex:mt,fragment:jt}}};var K;(function(r){r[r.BrowserSupport=1]="BrowserSupport",r[r.Other=2]="Other"})(K||(K={}));class Qt{}class p{static getContext_(t,e){const i=["webgl","experimental-webgl"];let s=null;for(let n=0;n<i.length;++n)try{s=t.getContext(i[n],e)}catch{if(s)break}return s}static getContext2_(t,e){let i=null;try{i=t.getContext("webgl2",e)}catch{}return i}static getFragmentVertex(t,e){let i;if(e){const s=p.inferVersion(e);s===V.WebGl2&&(e=e.replace(/^\#version\s*300\s*es.*?\n/,"")),/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*VERTEX)(?:\s*\))|(?:#ifdef)(?:\s*VERTEX)(?:\s*))/gm.exec(e)!==null&&(i=s===V.WebGl2?`#version 300 es
#define VERTEX
${e}`:`#define VERTEX
${e}`)}return i}static getIncludes(t,e=""){if(t===void 0)return Promise.resolve(t);const i=/#include\s*['|"](.*.glsl)['|"]/gm,s=[];let n=0,a;for(;(a=i.exec(t))!==null;){s.push(Promise.resolve(t.slice(n,a.index))),n=a.index+a[0].length;const o=a[1],h=I.getResource(o,e),u=o.indexOf(":/")===-1?I.dirname(h):"";s.push(I.fetch(h).then(f=>p.getIncludes(f,u)))}return s.push(Promise.resolve(t.slice(n))),Promise.all(s).then(o=>o.join(""))}static isWebGl(t){return t instanceof WebGLRenderingContext}static isWebGl2(t){return window.WebGL2RenderingContext&&t instanceof WebGL2RenderingContext}static inferVersion(t,e){const i=t||e;return i&&i.indexOf("#version 300 es")===0?V.WebGl2:V.WebGl}static inferPrecision(t){const e=t.match(/precision\s+(.+)\s+float/);return e&&e.length>1&&(p.precision=e[1]),p.precision}static versionDiffers(t,e,i){if(t){const s=this.isWebGl2(t)?V.WebGl2:V.WebGl;return p.inferVersion(e,i)!==s}else return!1}static getBufferVertex(t){return this.isWebGl2(t)?$t:Yt}static getVertex(t,e,i=S.Flat){if(t)return t;{const s=this.inferVersion(t,e);return vt[s][i===S.Flat?"flat":"mesh"].vertex}}static getFragment(t,e,i=S.Flat){if(e)return e;{const s=this.inferVersion(t,e);return vt[s][i===S.Flat?"flat":"mesh"].fragment}}static tryInferContext(t,e,i,s,n=[],a){function o(u,f){if(typeof a=="function")a(u);else{const c=i.parentNode;c&&(c.innerHTML=`<div class="glsl-canvas--error">${f}</div>`)}}if(!WebGLRenderingContext)return o(K.BrowserSupport,`This page requires a browser that supports WebGL.<br/>
			<a href="http://get.webgl.org">Click here to upgrade your browser.</a>`),null;const h=p.inferContext(t,e,i,s);if(!h)o(K.Other,`It does not appear your computer can support WebGL.<br/>
			<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`);else{!this.isWebGl2(h)&&n.indexOf("OES_standard_derivatives")===-1&&n.push("OES_standard_derivatives");const u=h.getSupportedExtensions();n.forEach(f=>{u.indexOf(f)!==-1?h.getExtension(f):U.warn(`GlslCanvas ${f} not supported`)})}return h}static tryGetContext(t,e,i){function s(a,o){if(typeof i=="function")i(a);else{const h=t.parentNode;h&&(h.innerHTML=`<div class="glsl-canvas--error">${o}</div>`)}}if(!WebGLRenderingContext)return s(K.BrowserSupport,`This page requires a browser that supports WebGL.<br/>
			<a href="http://get.webgl.org">Click here to upgrade your browser.</a>`),null;const n=p.getContext_(t,e);return n?n.getExtension("OES_standard_derivatives"):s(K.Other,`It does not appear your computer can support WebGL.<br/>
			<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`),n}static inferContext(t,e,i,s){return this.inferVersion(t,e)===V.WebGl2?this.getContext2_(i,s):this.getContext_(i,s)}static createShader(t,e,i,s=0){const n=t.createShader(i);if(e=e.replace(/precision\s+(.+)\s+float/,`precision ${p.precision} float`),t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw p.lastError=t.getShaderInfoLog(n),U.error(`*** Error compiling shader: ${p.lastError}`),t.deleteShader(n),{shader:n,source:e,type:i,error:p.lastError,offset:s};return n}static createProgram(t,e,i,s){const n=t.createProgram();for(let o=0;o<e.length;++o)t.attachShader(n,e[o]);if(i&&s)for(let o=0;o<i.length;++o)t.bindAttribLocation(n,s?s[o]:o,i[o]);return t.linkProgram(n),t.validateProgram(n),t.getProgramParameter(n,t.LINK_STATUS)?(t.useProgram(n),n):(p.lastError=t.getProgramInfoLog(n),U.error(`Error in program linking: ${p.lastError}`),t.deleteProgram(n),null)}static createVertexBuffers(t,e){const i=new Qt,s=t.getAttribLocation(e,"a_texcoord");i.texcoord=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.texcoord),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0);const n=t.getAttribLocation(e,"a_position");return i.position=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.position),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(n),t.vertexAttribPointer(n,2,t.FLOAT,!1,0,0),i}}p.precision=at.MediumP;p.lastError="";class Jt{}class ft{constructor(){this.values=new Jt}has(t){return t in this.values}set(t,e){this.values[t]=e}get(t){return this.values[t]}forEach(t){let e=0;Object.keys(this.values).forEach(i=>{t(this.values[i],e,this.values),e++})}reduce(t,e){let i=e,s=0;return Object.keys(this.values).forEach(n=>{i=t(i,this.values[n],s,this.values),s++}),i}}class O{constructor(t){t&&(Object.assign(this,t),this.positions&&(this.size=this.positions.length/3))}create(t,e){this.createData_(),this.createAttributes_(t,e)}createBufferData_(t,e,i){const s=t.createBuffer();return t.bindBuffer(e,s),t.bufferData(e,i,t.STATIC_DRAW),s}createAttribLocation_(t,e,i,s,n){const a=t.getAttribLocation(e,i);return t.enableVertexAttribArray(a),t.vertexAttribPointer(a,s,n,!1,0,0),a}createAttributes_(t,e){this.positions&&(this.positionBuffer=this.createBufferData_(t,t.ARRAY_BUFFER,new Float32Array(this.positions)),this.positionLocation=this.createAttribLocation_(t,e,"a_position",this.positions.length/this.size,t.FLOAT),t.bindAttribLocation(e,this.positionLocation,"a_position")),this.texcoords&&(this.texcoordBuffer=this.createBufferData_(t,t.ARRAY_BUFFER,new Float32Array(this.texcoords)),this.texcoordLocation=this.createAttribLocation_(t,e,"a_texcoord",this.texcoords.length/this.size,t.FLOAT),t.bindAttribLocation(e,this.texcoordLocation,"a_texcoord")),this.normals&&(this.normalBuffer=this.createBufferData_(t,t.ARRAY_BUFFER,new Float32Array(this.normals)),this.normalLocation=this.createAttribLocation_(t,e,"a_normal",this.normals.length/this.size,t.FLOAT),t.bindAttribLocation(e,this.normalLocation,"a_normal")),this.colors&&(this.colorBuffer=this.createBufferData_(t,t.ARRAY_BUFFER,new Float32Array(this.colors)),this.colorLocation=this.createAttribLocation_(t,e,"a_color",this.colors.length/this.size,t.FLOAT),t.bindAttribLocation(e,this.colorLocation,"a_color"))}attachAttributes_(t,e){let i;this.positions&&(i=t.getAttribLocation(e,"a_position"),t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.vertexAttribPointer(i,this.positions.length/this.size,t.FLOAT,!1,0,0)),this.texcoords&&(i=t.getAttribLocation(e,"a_texcoord"),t.enableVertexAttribArray(this.texcoordLocation),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer),t.vertexAttribPointer(this.texcoordLocation,this.texcoords.length/this.size,t.FLOAT,!1,0,0)),this.normals&&(i=t.getAttribLocation(e,"a_normal"),t.enableVertexAttribArray(this.normalLocation),t.bindBuffer(t.ARRAY_BUFFER,this.normalBuffer),t.vertexAttribPointer(this.normalLocation,this.normals.length/this.size,t.FLOAT,!1,0,0)),this.colors&&(i=t.getAttribLocation(e,"a_color"),t.enableVertexAttribArray(this.colorLocation),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.vertexAttribPointer(this.colorLocation,this.colors.length/this.size,t.FLOAT,!1,0,0))}bindAttributes_(t,e){this.positions&&t.bindAttribLocation(e,this.positionLocation,"a_position"),this.texcoords&&t.bindAttribLocation(e,this.texcoordLocation,"a_texcoord"),this.normals&&t.bindAttribLocation(e,this.normalLocation,"a_normal"),this.colors&&t.bindAttribLocation(e,this.colorLocation,"a_color")}createData_(){this.positions=[],this.normals=[],this.texcoords=[],this.colors=[],this.size=0}static fromIndices(t,e,i){const s=[];return t.forEach(n=>{s.push.apply(s,e.slice(n*i,n*i+i))}),s}}class ht extends O{createData_(){this.size=6,this.positions=[-1,-1,0,1,-1,0,1,1,0,-1,-1,0,1,1,0,-1,1,0],this.texcoords=[0,0,1,0,1,1,0,0,1,1,0,1],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],this.colors=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}var H;(function(r){r[r.FLOAT=0]="FLOAT",r[r.HALF_FLOAT=1]="HALF_FLOAT"})(H||(H={}));class F{constructor(t,e,i,s){const n=t.createFramebuffer(),a=F.getTexture(t,e,i,s);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.texture=a,this.buffer=n,this.BW=e,this.BH=i,this.index=s}static getFloatType(t){let e;return p.isWebGl2(t)&&(e=t.getExtension("EXT_color_buffer_float"),e)||(e=t.getExtension("OES_texture_float"),e)?t.FLOAT:null}static getHalfFloatType(t){let e;return p.isWebGl2(t)&&(e=t.getExtension("EXT_color_buffer_half_float")||t.getExtension("EXT_color_buffer_float"),e)?t.HALF_FLOAT:(e=t.getExtension("OES_texture_half_float"),e&&e.HALF_FLOAT_OES||null)}static getInternalFormat(t){return p.isWebGl2(t)?t.RGBA16F:t.RGBA}static getType(t){let e;return F.type===H.HALF_FLOAT?(e=F.getHalfFloatType(t),e||(F.type=H.FLOAT,F.getType(t))):(e=F.getFloatType(t),e||(F.type=H.HALF_FLOAT,F.getType(t)))}static getTexture(t,e,i,s){const n=F.getInternalFormat(t),a=t.RGBA,o=F.getType(t),h=t.createTexture();return t.activeTexture(t.TEXTURE0+s),t.bindTexture(t.TEXTURE_2D,h),t.texImage2D(t.TEXTURE_2D,0,n,e,i,0,a,o,null),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE?(F.type===H.FLOAT?F.type=H.HALF_FLOAT:F.type=H.FLOAT,F.getTexture(t,e,i,s)):h}resize(t,e,i){if(e!==this.BW||i!==this.BH){const s=this.buffer,n=this.texture,a=this.index;t.bindFramebuffer(t.FRAMEBUFFER,s);const o=t.checkFramebufferStatus(t.FRAMEBUFFER),h=Math.min(e,this.BW),u=Math.min(i,this.BH);let f,c=F.getType(t);o===t.FRAMEBUFFER_COMPLETE&&(f=new Float32Array(h*u*4),t.readPixels(0,0,h,u,t.RGBA,c,f)),t.bindFramebuffer(t.FRAMEBUFFER,null);const m=a+1,T=F.getTexture(t,e,i,m);c=F.getType(t),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),f&&t.texSubImage2D(t.TEXTURE_2D,0,0,0,h,u,t.RGBA,c,f);const E=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteTexture(n),t.activeTexture(t.TEXTURE0+a),t.bindTexture(t.TEXTURE_2D,T),this.index=a,this.texture=T,this.buffer=E,this.BW=e,this.BH=i}}}F.type=H.HALF_FLOAT;class Zt{constructor(t,e,i,s){this.isValid=!1,this.index=t,this.key=e,this.vertexString=i,this.fragmentString=s,this.geometry=new ht}create(t,e,i){const s=p.createShader(t,this.vertexString,t.VERTEX_SHADER);let n=p.createShader(t,this.fragmentString,t.FRAGMENT_SHADER,1);n?this.isValid=!0:(n=p.createShader(t,p.isWebGl2(t)?Kt:qt,t.FRAGMENT_SHADER),this.isValid=!1);const a=p.createProgram(t,[s,n]);if(!a){this.isValid=!1,t.deleteShader(s),t.deleteShader(n);return}this.geometry.create(t,a),t.deleteShader(s),t.deleteShader(n);const o=new F(t,e,i,this.index+0),h=new F(t,e,i,this.index+2);this.program=a,this.input=o,this.output=h}render(t,e,i){t.useProgram(this.program),t.bindFramebuffer(t.FRAMEBUFFER,this.output.buffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.output.texture,0),t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE&&(t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)),t.viewport(0,0,e,i),t.drawArrays(t.TRIANGLES,0,this.geometry.size);const n=this.input;this.input=this.output,this.output=n}resize(t,e,i){t.useProgram(this.program),t.viewport(0,0,e,i),this.input.resize(t,e,i),this.output.resize(t,e,i)}destroy(t){t.deleteProgram(this.program),this.program=null,this.input=null,this.output=null}}class tt extends ft{get count(){return Object.keys(this.values).length*4}static getBuffers(t,e,i){const s=new tt;let n=0;if(e){p.isWebGl2(t)&&(e=e.replace(/^\#version\s*300\s*es\s*\n/,""));const a=/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*BUFFER_)(\d+)(?:\s*\))|(?:#ifdef)(?:\s*BUFFER_)(\d+)(?:\s*))/gm;let o;for(;(o=a.exec(e))!==null;){const h=o[3]||o[4],u="u_buffer"+h,f=p.isWebGl2(t)?`#version 300 es
#define BUFFER_${h}
${e}`:`#define BUFFER_${h}
${e}`,c=new Zt(n,u,i,f);if(c.create(t,t.drawingBufferWidth,t.drawingBufferHeight),c.program)s.set(u,c);else throw`buffer error ${u}`;n+=4}}return s}}class st{constructor(t=0,e=0){this.isVector2=!0,this.x=t,this.y=e}copy(t){return this.x=t.x,this.y=t.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){return this.divideScalar(this.length()||1)}divideScalar(t){return this.multiplyScalar(1/t)}multiplyScalar(t){return this.x*=t,this.y*=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}}class D{constructor(t=0,e=0,i=0){this.isVector3=!0,this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){return this.divideScalar(this.length()||1)}divideScalar(t){return this.multiplyScalar(1/t)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}crossVectors(t,e){var i=t.x,s=t.y,n=t.z,a=e.x,o=e.y,h=e.z;return this.x=s*h-n*o,this.y=n*a-i*h,this.z=i*o-s*a,this}}const te=Math.PI,$=te/180;class rt extends D{constructor(t,e,i){super(),this.position=new D,this.value=new Float32Array([0,0,0]),this.mouse=null,this.dirty=!1,this.theta=(t||0)*$,this.phi=(e||0)*$,this.radius=i||6}down(t,e){this.mouse=new st(t,e)}move(t,e){const i=this.mouse;if(i&&(i.x!==t||i.y!==e)){const s=(t-i.x)*180*$,n=(e-i.y)*180*$;i.x=t,i.y=e,this.theta+=s,this.phi=Math.max(-60*$,Math.min(60*$,this.phi+n))}}up(){this.mouse=null}wheel(t){this.radius=Math.max(4,Math.min(10,this.radius+t*.02))}static fromVector(t){const e=t.length(),i=Math.acos(t.y/e),s=Math.atan(t.x/t.z);return new rt(i,s,e)}static toArray(t){const e=Math.sin(t.phi)*t.radius,i=e*Math.sin(t.theta),s=Math.cos(t.phi)*t.radius,n=e*Math.cos(t.theta);return[i,s,n]}}var ee=1e-6,pt=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var r=0,t=arguments.length;t--;)r+=arguments[t]*arguments[t];return Math.sqrt(r)});function q(){var r=new pt(16);return pt!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function xt(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function ie(r,t){if(r===t){var e=t[1],i=t[2],s=t[3],n=t[6],a=t[7],o=t[11];r[1]=t[4],r[2]=t[8],r[3]=t[12],r[4]=e,r[6]=t[9],r[7]=t[13],r[8]=i,r[9]=n,r[11]=t[14],r[12]=s,r[13]=a,r[14]=o}else r[0]=t[0],r[1]=t[4],r[2]=t[8],r[3]=t[12],r[4]=t[1],r[5]=t[5],r[6]=t[9],r[7]=t[13],r[8]=t[2],r[9]=t[6],r[10]=t[10],r[11]=t[14],r[12]=t[3],r[13]=t[7],r[14]=t[11],r[15]=t[15];return r}function se(r,t){var e=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],u=t[7],f=t[8],c=t[9],m=t[10],T=t[11],E=t[12],M=t[13],l=t[14],x=t[15],w=e*o-i*a,_=e*h-s*a,b=e*u-n*a,A=i*h-s*o,g=i*u-n*o,L=s*u-n*h,R=f*M-c*E,P=f*l-m*E,G=f*x-T*E,B=c*l-m*M,C=c*x-T*M,W=m*x-T*l,y=w*W-_*C+b*B+A*G-g*P+L*R;return y?(y=1/y,r[0]=(o*W-h*C+u*B)*y,r[1]=(s*C-i*W-n*B)*y,r[2]=(M*L-l*g+x*A)*y,r[3]=(m*g-c*L-T*A)*y,r[4]=(h*G-a*W-u*P)*y,r[5]=(e*W-s*G+n*P)*y,r[6]=(l*b-E*L-x*_)*y,r[7]=(f*L-m*b+T*_)*y,r[8]=(a*C-o*G+u*R)*y,r[9]=(i*G-e*C-n*R)*y,r[10]=(E*g-M*b+x*w)*y,r[11]=(c*b-f*g-T*w)*y,r[12]=(o*P-a*B-h*R)*y,r[13]=(e*B-i*P+s*R)*y,r[14]=(M*_-E*A-l*w)*y,r[15]=(f*A-c*_+m*w)*y,r):null}function re(r,t,e){var i=e[0],s=e[1],n=e[2],a,o,h,u,f,c,m,T,E,M,l,x;return t===r?(r[12]=t[0]*i+t[4]*s+t[8]*n+t[12],r[13]=t[1]*i+t[5]*s+t[9]*n+t[13],r[14]=t[2]*i+t[6]*s+t[10]*n+t[14],r[15]=t[3]*i+t[7]*s+t[11]*n+t[15]):(a=t[0],o=t[1],h=t[2],u=t[3],f=t[4],c=t[5],m=t[6],T=t[7],E=t[8],M=t[9],l=t[10],x=t[11],r[0]=a,r[1]=o,r[2]=h,r[3]=u,r[4]=f,r[5]=c,r[6]=m,r[7]=T,r[8]=E,r[9]=M,r[10]=l,r[11]=x,r[12]=a*i+f*s+E*n+t[12],r[13]=o*i+c*s+M*n+t[13],r[14]=h*i+m*s+l*n+t[14],r[15]=u*i+T*s+x*n+t[15]),r}function _t(r,t,e,i){var s=i[0],n=i[1],a=i[2],o=Math.hypot(s,n,a),h,u,f,c,m,T,E,M,l,x,w,_,b,A,g,L,R,P,G,B,C,W,y,Z;return o<ee?null:(o=1/o,s*=o,n*=o,a*=o,h=Math.sin(e),u=Math.cos(e),f=1-u,c=t[0],m=t[1],T=t[2],E=t[3],M=t[4],l=t[5],x=t[6],w=t[7],_=t[8],b=t[9],A=t[10],g=t[11],L=s*s*f+u,R=n*s*f+a*h,P=a*s*f-n*h,G=s*n*f-a*h,B=n*n*f+u,C=a*n*f+s*h,W=s*a*f+n*h,y=n*a*f-s*h,Z=a*a*f+u,r[0]=c*L+M*R+_*P,r[1]=m*L+l*R+b*P,r[2]=T*L+x*R+A*P,r[3]=E*L+w*R+g*P,r[4]=c*G+M*B+_*C,r[5]=m*G+l*B+b*C,r[6]=T*G+x*B+A*C,r[7]=E*G+w*B+g*C,r[8]=c*W+M*y+_*Z,r[9]=m*W+l*y+b*Z,r[10]=T*W+x*y+A*Z,r[11]=E*W+w*y+g*Z,t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r)}function ne(r,t,e,i,s){var n=1/Math.tan(t/2),a;return r[0]=n/e,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=n,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,s!=null&&s!==1/0?(a=1/(i-s),r[10]=(s+i)*a,r[14]=2*s*i*a):(r[10]=-1,r[14]=-2*i),r}class oe{constructor(){this.delay=0,this.current=0,this.delta=0,this.paused=!1,this.start=this.previous=this.now()}now(){return performance.now()}play(){if(this.previous){const t=this.now();this.delay+=t-this.previous,this.previous=t}this.paused=!1}pause(){this.paused=!0}next(){const t=this.now();return this.delta=t-this.previous,this.current=t-this.start-this.delay,this.previous=t,this}}class Et{constructor(t,e){this.event=t,this.callback=e}}class Rt{constructor(){this.listeners=new Set}logListeners(){this.listeners.forEach(t=>U.log(t))}subscribe(t){this.listeners.add(t)}unsubscribe(t){this.listeners.delete(t)}unsubscribeAll(){this.listeners.clear()}on(t,e){return this.listeners.add(new Et(t,e)),this}off(t,e){return e?this.listeners.delete(new Et(t,e)):this.listeners.forEach(i=>{i.event===t&&this.listeners.delete(i)}),this}trigger(t,...e){return this.listeners.forEach(i=>{i.event===t&&typeof i.callback=="function"&&i.callback(...e)}),this}}class ae extends O{createData_(){this.size=36,this.positions=[-1,-1,1,1,-1,1,1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1],this.texcoords=[0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0];const t=[[1,1,1,1],[1,0,0,1],[0,1,0,1],[0,0,1,1],[1,1,0,1],[1,0,1,1]];let e=[];for(var i=0;i<t.length;++i){const s=t[i];e=e.concat(s,s,s,s,s,s)}this.colors=e}}class he extends O{createData_(){const n=Math.PI*2,a=0,o=Math.PI,h=new D,u=new D,f=[],c=[],m=[],T=[],E=[];let M=Math.min(a+o,Math.PI),l,x,w=0,_=[];for(x=0;x<=60;x++){let b=[],A=x/60,g=0;for(x==0&&a==0?g=.5/80:x==60&&M==Math.PI&&(g=-.5/80),l=0;l<=80;l++){let L=l/80;h.x=-1.4*Math.cos(0+L*n)*Math.sin(a+A*o),h.y=1.4*Math.cos(a+A*o),h.z=1.4*Math.sin(0+L*n)*Math.sin(a+A*o),c.push(h.x,h.y,h.z),u.copy(h).normalize(),m.push(u.x,u.y,u.z);const R=L+g,P=1-A;T.push(R,P),E.push(1,1,1,1),b.push(w++)}_.push(b)}for(x=0;x<60;x++)for(l=0;l<80;l++){const b=_[x][l+1],A=_[x][l],g=_[x+1][l],L=_[x+1][l+1];(x!==0||a>0)&&f.push(b,A,L),(x!==60-1||M<Math.PI)&&f.push(A,g,L)}this.size=f.length,this.positions=O.fromIndices(f,c,3),this.texcoords=O.fromIndices(f,T,2),this.normals=O.fromIndices(f,m,3),this.colors=O.fromIndices(f,E,4)}}class ce extends O{createData_(){const o=[],h=[],u=[],f=[],c=[],m=new D,T=new D,E=new D,M=new D,l=new D,x=new D,w=new D;for(let _=0;_<=200;++_){const b=_/200*2*Math.PI*2;this.calculatePositionOnCurve(b,2,3,1,E),this.calculatePositionOnCurve(b+.01,2,3,1,M),x.subVectors(M,E),w.addVectors(M,E),l.crossVectors(x,w),w.crossVectors(l,x),l.normalize(),w.normalize();for(let A=0;A<=40;++A){const g=A/40*Math.PI*2,L=-.25*Math.cos(g),R=.25*Math.sin(g);m.x=E.x+(L*w.x+R*l.x),m.y=E.y+(L*w.y+R*l.y),m.z=E.z+(L*w.z+R*l.z),h.push(m.x,m.y,m.z),T.subVectors(m,E).normalize(),u.push(T.x,T.y,T.z),f.push(_/200*2*Math.round(3)),f.push(A/40),c.push(1,1,1,1)}}for(let _=1;_<=200;_++)for(let b=1;b<=40;b++){const A=41*(_-1)+(b-1),g=(40+1)*_+(b-1),L=(40+1)*_+b,R=(40+1)*(_-1)+b;o.push(A,g,R),o.push(g,L,R)}this.size=o.length,this.positions=O.fromIndices(o,h,3),this.texcoords=O.fromIndices(o,f,2),this.normals=O.fromIndices(o,u,3),this.colors=O.fromIndices(o,c,4)}calculatePositionOnCurve(t,e,i,s,n){const a=Math.cos(t),o=Math.sin(t),h=i/e*t,u=Math.cos(h);n.x=s*(2+u)*.5*a,n.y=s*(2+u)*o*.5,n.z=s*Math.sin(h)*.5}}const bt=[[1,1,1],[1,0,0],[0,1,0],[0,0,1],[1,1,0],[0,1,1]];let nt=0;class ue{load(t){return new Promise((e,i)=>{I.fetch(t).then(s=>{const n=this.parse(s);if(n.positions.length){const a=new O(n);e(a)}else i(`ObjLoader error: empty positions ${t}`)},s=>{console.log("ObjLoader error:",s,t),i(s)})})}parseIndices(t,e,i,s,n,a){let o=0;for(;o<=t.length-3;){let h,u,f;o===0?(h=o,u=o+1,f=o+2):(h=o-1,u=o+1,f=o+2),o++;const c=[h,u,f];for(let m=0;m<c.length;m++){const T=t[c[m]][e];let E;T&&T!==NaN&&(E=s[T-1],E&&(E=E.slice(0,i),n.push.apply(n,E)))}}}parseFaces(t,e,i,s,n,a,o,h){const u=n.length;t.forEach(c=>{this.parseIndices(c,0,3,e,n,"positions"),this.parseIndices(c,2,3,i,a,"normals"),this.parseIndices(c,1,2,s,o,"texcoords")});const f=n.length-u;f>0&&(new Array(f/3).fill(0).forEach(()=>{const m=bt[nt%bt.length];h.push(m[0],m[1],m[2],1)}),nt++)}parse(t){let e=[],i=[],s=[],n=[];nt=0;let a=[],o=[],h=[],u=[];t.indexOf(`\r
`)!==-1&&(t=t.replace(/\r\n/g,`
`)),t=t.replace(/  /g," "),t.split(`
`).forEach((l,x)=>{if(l.indexOf("v ")===0){u.length&&(this.parseFaces(u,a,o,h,e,i,s,n),u=[]);const _=l.replace("v","").trim().split(" ").map(b=>parseFloat(b));a.push(_)}else if(l.indexOf("vn ")===0){const _=l.replace("vn","").trim().split(" ").map(A=>parseFloat(A)),b=new D(_[0],_[1],_[2]).normalize();o.push([b.x,b.y,b.z])}else if(l.indexOf("vt ")===0){const _=l.replace("vt","").trim().split(" ").map(b=>parseFloat(b));h.push(_)}else if(l.indexOf("f ")===0){const _=l.replace("f","").trim().split(" ").map(b=>{const A=b.split("/").map(g=>parseInt(g));return A.length===2&&A.push(null),A});u[u.length]=_}}),u.length&&this.parseFaces(u,a,o,h,e,i,s,n);const c={min:new D(Number.POSITIVE_INFINITY),max:new D(Number.NEGATIVE_INFINITY)};for(let l=0;l<e.length;l+=3)c.min.x=Math.min(c.min.x,e[l]),c.min.y=Math.min(c.min.y,e[l+1]),c.min.z=Math.min(c.min.z,e[l+2]),c.max.x=Math.max(c.max.x,e[l]),c.max.y=Math.max(c.max.y,e[l+1]),c.max.z=Math.max(c.max.z,e[l+2]);const m=-(c.min.x+c.max.x)/2,T=-(c.min.y+c.max.y)/2,E=-(c.min.z+c.max.z)/2;for(let l=0;l<e.length;l+=3)e[l]+=m,e[l+1]+=T,e[l+2]+=E;const M=e.reduce((l,x)=>Math.max(l,x),0);return e.forEach((l,x)=>e[x]=l/M*2),i.length||(i=e.slice()),s.length||(s=this.unrapUvw(e)),{positions:e,normals:i,texcoords:s,colors:n}}unrapUvw(t){const e=[];for(let i=0;i<t.length;i+=3){const s=new D(t[i],t[i+1],t[i+2]);s.normalize();const n=Math.asin(-s.y),a=Math.atan2(s.x,s.z),o=.5+n/Math.PI,h=.5+a/(Math.PI*2);e.push(o,h)}return e}}const fe=["ogv","webm","mp4"];var Y;(function(r){r[r.Data=0]="Data",r[r.Element=1]="Element",r[r.Url=2]="Url"})(Y||(Y={}));var X;(function(r){r.MipMap="mipmap",r.Linear="linear",r.Nearest="nearest"})(X||(X={}));function le(r){return"data"in r&&"width"in r&&"height"in r}class N extends Rt{constructor(t,e,i,s={filtering:X.Linear},n){super(),this.valid=!1,this.dirty=!1,this.animated=!1,this.powerOf2=!1,this.key=e,this.index=i,this.options=s,this.workpath=n,this.create(t)}static isPowerOf2(t){return(t&t-1)===0}static isSafari(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}static isTextureUrl(t){return t&&/\.(jpg|jpeg|png|ogv|webm|mp4)$/i.test(t.split("?")[0])}static isTexture(t){return N.getTextureOptions(t)!==void 0}static getMaxTextureSize(t){return t.getParameter(t.MAX_TEXTURE_SIZE)}static getTextureOptions(t,e={}){if(typeof t=="string"&&t!==""){if(N.isTextureUrl(t))return e.url=t,t.indexOf("?")!==-1&&(e=t.split("?")[1].split("&").reduce(function(i,s){const n=s.split("="),a=decodeURIComponent(n[0]),o=decodeURIComponent(n[1]);switch(a){case"filtering":i[a]=o;break;case"repeat":case"UNPACK_FLIP_Y_WEBGL":i[a]=Boolean(o);break;case"UNPACK_PREMULTIPLY_ALPHA_WEBGL":case"TEXTURE_WRAP_S":case"TEXTURE_WRAP_T":i[a]=Number(o);break}return i},e)),e;document&&(t=document.querySelector(t))}return t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement?(e.element=t,e):le(t)?(e.data=t.data,e.width=t.width,e.height=t.height,e):null}create(t){this.texture=t.createTexture(),this.texture&&(this.valid=!0),this.setData(t,1,1,new Uint8Array([0,0,0,0]),this.options)}load(t,e={}){return this.options=e,typeof e.url=="string"?this.url===void 0||e.url!==this.url?this.setUrl(t,e.url,e):Promise.resolve(this):e.element?this.setElement(t,e.element,e):e.data&&e.width&&e.height?this.setData(t,e.width,e.height,e.data,e):Promise.reject(this)}setUrl(t,e,i={}){if(!this.valid)return Promise.reject(this);this.url=e,this.source=e,this.sourceType=Y.Url,this.options=Object.assign(this.options,i);const s=e.split("?")[0].split(".").pop().toLowerCase(),n=fe.indexOf(s)!==-1,a=I.getResource(e,this.workpath);let o,h;return n?(U.log("GlslCanvas.setUrl video",a),o=document.createElement("video"),o.setAttribute("preload","auto"),o.setAttribute("loop","true"),o.setAttribute("muted","true"),o.setAttribute("playsinline","true"),o.loop=!0,o.muted=!0,h=this.setElement(t,o,i),o.src=a,o.addEventListener("canplay",()=>{o.play()})):(U.log("GlslCanvas.setUrl image",a),o=document.createElement("img"),h=this.setElement(t,o,i),N.isSafari()&&e.slice(0,5)==="data:"||(o.crossOrigin="anonymous"),o.src=a),h}setElement(t,e,i={}){return i=this.options=Object.assign(this.options,i),new Promise((s,n)=>{const a=e;if(typeof e=="string"&&(e=document.querySelector(e)),e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)if(this.source=e,this.sourceType=Y.Element,e instanceof HTMLVideoElement){const o=e;o.addEventListener("loadeddata",h=>{this.update(t,i),this.setFiltering(t,i),s(this)}),o.addEventListener("error",h=>{n(h)}),o.load()}else e instanceof HTMLImageElement?(e.addEventListener("load",()=>{this.update(t,i),this.setFiltering(t,i),s(this)}),e.addEventListener("error",o=>{n(o)})):(this.update(t,i),this.setFiltering(t,i),s(this));else{let o=`the 'element' parameter (\`element: ${JSON.stringify(a)}\`) must be a CSS selector string, or a <canvas>, <image> or <video> object`;U.log(`Texture '${this.key}': ${o}`,i),n(o)}})}setData(t,e,i,s,n={}){return this.width=e,this.height=i,this.options=Object.assign(this.options,n),this.source=s,this.sourceType=Y.Data,this.update(t,n),this.setFiltering(t,n),Promise.resolve(this)}update(t,e){if(!!this.valid){if(t.activeTexture(t.TEXTURE0+this.index),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.UNPACK_FLIP_Y_WEBGL===!1?0:1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.UNPACK_PREMULTIPLY_ALPHA_WEBGL||0),this.sourceType===Y.Element)this.source instanceof HTMLImageElement&&this.source.naturalWidth&&this.source.naturalHeight?(this.width=this.source.naturalWidth,this.height=this.source.naturalHeight,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source)):this.source instanceof HTMLVideoElement&&this.source.videoWidth&&this.source.videoHeight?(this.width=this.source.videoWidth,this.height=this.source.videoHeight,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source)):this.source instanceof HTMLCanvasElement&&(this.width=this.source.width,this.height=this.source.height,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source));else if(this.sourceType===Y.Data){const i=this.source;t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,i)}this.trigger("loaded",this)}}tryUpdate(t){let e=!1;return this.animated&&(e=!0,this.update(t,this.options)),e}destroy(t){!this.valid||(t.deleteTexture(this.texture),this.texture=null,delete this.source,this.source=null,this.valid=!1)}setFiltering(t,e){if(!this.valid)return;const i=N.isPowerOf2(this.width)&&N.isPowerOf2(this.height);let s=e.filtering||X.MipMap,n=e.TEXTURE_WRAP_S||(e.repeat?t.REPEAT:t.CLAMP_TO_EDGE),a=e.TEXTURE_WRAP_T||(e.repeat?t.REPEAT:t.CLAMP_TO_EDGE);i||(s=s===X.MipMap?X.Linear:s,n=a=t.CLAMP_TO_EDGE,(e.repeat||e.TEXTURE_WRAP_S||e.TEXTURE_WRAP_T)&&U.warn(`GlslCanvas: cannot repeat texture ${e.url} cause is not power of 2.`)),this.powerOf2=i,this.filtering=s,t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,a),this.filtering===X.MipMap?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D)):this.filtering===X.Nearest?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)):this.filtering===X.Linear&&(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR))}}class St extends ft{constructor(){super(...arguments),this.count=0,this.dirty=!1,this.animated=!1}clean(){Object.keys(this.values).forEach(t=>{this.values[t].dirty=!1}),this.dirty=!1}createOrUpdate(t,e,i,s=0,n={},a){let o;const h=N.getTextureOptions(i,n);return o=this.get(e),o||(o=new N(t,e,s+this.count,h,a),this.count++,this.set(e,o)),h!==void 0?o.load(t,h).then(u=>{if(u.source instanceof HTMLVideoElement){const f=u.source;f.addEventListener("play",()=>{u.animated=!0,this.animated=!0}),f.addEventListener("pause",()=>{u.animated=!1,this.animated=this.reduce((c,m)=>c||m.animated,!1)}),f.addEventListener("seeked",()=>{u.update(t,u.options),this.dirty=!0})}return u}):Promise.resolve(o)}}var d;(function(r){r[r.Unknown=0]="Unknown",r.Uniform1i="uniform1i",r.Uniform2i="uniform2i",r.Uniform3i="uniform3i",r.Uniform4i="uniform4i",r.Uniform1f="uniform1f",r.Uniform2f="uniform2f",r.Uniform3f="uniform3f",r.Uniform4f="uniform4f",r.Uniform1iv="uniform1iv",r.Uniform2iv="uniform2iv",r.Uniform3iv="uniform3iv",r.Uniform4iv="uniform4iv",r.Uniform1fv="uniform1fv",r.Uniform2fv="uniform2fv",r.Uniform3fv="uniform3fv",r.Uniform4fv="uniform4fv",r.UniformMatrix2fv="uniformMatrix2fv",r.UniformMatrix3fv="uniformMatrix3fv",r.UniformMatrix4fv="uniformMatrix4fv"})(d||(d={}));var v;(function(r){r[r.Unknown=0]="Unknown",r[r.Float=1]="Float",r[r.Int=2]="Int",r[r.Bool=3]="Bool",r[r.Sampler2D=4]="Sampler2D",r[r.SamplerCube=5]="SamplerCube",r[r.Matrix2fv=6]="Matrix2fv",r[r.Matrix3fv=7]="Matrix3fv",r[r.Matrix4fv=8]="Matrix4fv"})(v||(v={}));const Tt=[d.Uniform1i,d.Uniform2i,d.Uniform3i,d.Uniform4i],At=[d.Uniform1f,d.Uniform2f,d.Uniform3f,d.Uniform4f],yt=[d.Uniform1iv,d.Uniform2iv,d.Uniform3iv,d.Uniform4iv],Mt=[d.Uniform1fv,d.Uniform2fv,d.Uniform3fv,d.Uniform4fv];class it{constructor(t){switch(this.dirty=!0,t&&Object.assign(this,t),this.method){case d.UniformMatrix2fv:case d.UniformMatrix3fv:case d.UniformMatrix4fv:this.apply=(e,i)=>{if(this.dirty){e.useProgram(i);const s=e.getUniformLocation(i,this.key);e[this.method].apply(e,[s,!1].concat(this.values))}};break;default:this.apply=(e,i)=>{if(this.dirty){e.useProgram(i);const s=e.getUniformLocation(i,this.key);e[this.method].apply(e,[s].concat(this.values))}}}}}class wt extends it{constructor(t){super(t)}}class z extends ft{constructor(){super(...arguments),this.dirty=!1}static isArrayOfInteger(t){return t.reduce((e,i)=>e&&Number.isInteger(i),!0)}static isArrayOfNumber(t){return t.reduce((e,i)=>e&&typeof i=="number",!0)}static isArrayOfBoolean(t){return t.reduce((e,i)=>e&&typeof i=="boolean",!0)}static isArrayOfTexture(t){return t.reduce((e,i)=>e&&N.isTexture(i),!0)}static isArrayOfSampler2D(t){return t.reduce((e,i)=>e&&i.type===v.Sampler2D,!0)}static getType_(t){let e=v.Unknown;const s=t.length===1&&Array.isArray(t[0])?t[0]:t;return z.isArrayOfNumber(s)?e=v.Float:z.isArrayOfBoolean(s)?e=v.Bool:z.isArrayOfTexture(s)&&(e=v.Sampler2D),e}static getMethod_(t,e){let i=d.Unknown;const s=e.length===1&&Array.isArray(e[0]),a=(s?e[0]:e).length,o=a-1;switch(t){case v.Float:s?i=o<Mt.length?Mt[o]:d.Unknown:i=o<At.length?At[o]:d.Uniform1fv;break;case v.Int:case v.Bool:s?i=o<yt.length?yt[o]:d.Unknown:i=o<Tt.length?Tt[o]:d.Uniform1iv;break;case v.Sampler2D:s?i=d.Uniform1iv:i=a===1?d.Uniform1i:d.Uniform1iv;break}return i}static parseUniform(t,e,i=null){let s;i=i||z.getType_(e);const n=z.getMethod_(i,e);if(i!==v.Unknown&&n!==d.Unknown){if(i===v.Sampler2D&&n===d.Uniform1iv)return e[0].map((a,o)=>new it({method:n,type:i,key:`${t}[${o}]`,values:[a]}));s=new it({method:n,type:i,key:t,values:e})}else U.error("Uniforms.parseUniform.Unknown",t,e);return s}create(t,e,i,s){const n=new it({method:t,type:e,key:i,values:s});return this.set(i,n),this.dirty=!0,n}createTexture(t,e){let i;return t.indexOf("]")!==-1?i=new wt({method:d.Uniform1iv,type:v.Sampler2D,key:t,values:[[e]]}):i=new wt({method:d.Uniform1i,type:v.Sampler2D,key:t,values:[e]}),this.set(t,i),this.dirty=!0,i}update(t,e,i,s){const n=this.get(i);n&&(n.method=t,n.type=e,n.values=s,n.dirty=!0,this.dirty=!0)}createOrUpdate(t,e,i,s){this.has(i)?this.update(t,e,i,s):this.create(t,e,i,s)}apply(t,e){t.useProgram(e),Object.keys(this.values).forEach(i=>{this.values[i].apply(t,e)})}clean(){Object.keys(this.values).forEach(t=>{this.values[t].dirty=!1}),this.dirty=!1}static isDifferent(t,e){return t.length!==e.length||t.reduce((i,s,n)=>i||s!==e[n],!1)}}class de extends Rt{constructor(){super(),this.uniforms=new z,this.buffers=new tt,this.textures=new St,this.textureList=[],this.W=0,this.H=0,this.mouse=new st,this.radians=0,this.dirty=!0,this.animated=!1,this.camera=new rt,this.cache={},this.drawFunc_=this.drawArrays_}render(){const t=this.gl;if(!t)return;const e=t.drawingBufferWidth,i=t.drawingBufferHeight;this.update_(),t.viewport(0,0,e,i);const s=this.uniforms;Object.keys(this.buffers.values).forEach(n=>{const a=this.buffers.values[n];a.geometry.attachAttributes_(t,a.program),s.apply(t,a.program),a.render(t,e,i)}),this.geometry.attachAttributes_(t,this.program),s.apply(t,this.program),this.drawFunc_(this.timer.delta),s.clean(),this.textures.clean(),this.dirty=!1,this.trigger("render",this)}drawArrays_(t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.W,this.H),e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),this.doubleSided&&this.mode!==S.Flat&&(e.cullFace(e.FRONT),e.drawArrays(e.TRIANGLES,0,this.geometry.size),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)),e.cullFace(e.BACK),e.drawArrays(e.TRIANGLES,0,this.geometry.size)}create_(){this.createGeometry_(),this.createUniforms_()}createGeometry_(){this.parseGeometry_(),this.setMode(this.mode)}parseGeometry_(){const e=/^attribute\s+vec4\s+a_position\s*;\s*\/\/\s*([\w|\:\/\/|\.|\-|\_|\?|\&|\=]+)/gm.exec(this.vertexString);e&&e.length>1?this.mesh=e[1]:this.mesh=this.defaultMesh}createUniforms_(){const t=this.gl,e=this.fragmentString,i=t.drawingBufferWidth,s=t.drawingBufferHeight,n=this.timer=new oe,a=(e.match(/u_delta/g)||[]).length>1,o=(e.match(/u_time/g)||[]).length>1,h=(e.match(/u_date/g)||[]).length>1,u=(e.match(/u_mouse/g)||[]).length>1,f=(e.match(/u_camera/g)||[]).length>1;this.animated=!0;const c=this.uniforms;if(c.create(d.Uniform2f,v.Float,"u_resolution",[i,s]),a?(c.create(d.Uniform1f,v.Float,"u_delta",[n.delta/1e3]),this.updateUniformDelta_=this.updateUniformDelta__):this.updateUniformDelta_=this.updateUniformNoop_,o?(c.create(d.Uniform1f,v.Float,"u_time",[n.current/1e3]),this.updateUniformTime_=this.updateUniformTime__):this.updateUniformTime_=this.updateUniformNoop_,h){const m=new Date;c.create(d.Uniform4f,v.Float,"u_date",[m.getFullYear(),m.getMonth(),m.getDate(),m.getHours()*3600+m.getMinutes()*60+m.getSeconds()+m.getMilliseconds()*.001]),this.updateUniformDate_=this.updateUniformDate__}else this.updateUniformDate_=this.updateUniformNoop_;u?(c.create(d.Uniform2f,v.Float,"u_mouse",[0,0]),this.updateUniformMouse_=this.updateUniformMouse__):this.updateUniformMouse_=this.updateUniformNoop_,f?(c.create(d.Uniform3f,v.Float,"u_camera",[0,0,0]),this.updateUniformCamera_=this.updateUniformCamera__):this.updateUniformCamera_=this.updateUniformNoop_,this.projectionMatrix=q(),c.create(d.UniformMatrix4fv,v.Float,"u_projectionMatrix",this.projectionMatrix),this.modelViewMatrix=q(),c.create(d.UniformMatrix4fv,v.Float,"u_modelViewMatrix",this.modelViewMatrix),this.normalMatrix=q(),c.create(d.UniformMatrix4fv,v.Float,"u_normalMatrix",this.normalMatrix)}update_(){const t=this.gl,e=t.drawingBufferWidth,i=t.drawingBufferHeight;if(!this.timer)return;const s=this.timer.next();this.uniforms.update(d.Uniform2f,v.Float,"u_resolution",[e,i]),this.updateUniformDelta_(s),this.updateUniformTime_(s),this.updateUniformDate_(),this.updateUniformMouse_(),this.updateUniformCamera_(),this.updateUniformMesh_()}updateUniformNoop_(){}updateUniformDelta__(t){this.uniforms.update(d.Uniform1f,v.Float,"u_delta",[t.delta/1e3])}updateUniformTime__(t){this.uniforms.update(d.Uniform1f,v.Float,"u_time",[t.current/1e3])}updateUniformDate__(){const t=this.uniforms,e=new Date;t.update(d.Uniform4f,v.Float,"u_date",[e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()*3600+e.getMinutes()*60+e.getSeconds()+e.getMilliseconds()*.001])}updateUniformMouse__(){const t=this.uniforms,e=this.mouse;t.update(d.Uniform2f,v.Float,"u_mouse",[e.x,e.y])}updateUniformCamera__(){const t=this.uniforms,e=rt.toArray(this.camera);t.update(d.Uniform3f,v.Float,"u_camera",e)}updateUniformMesh__(){const t=this.uniforms;t.update(d.UniformMatrix4fv,v.Float,"u_projectionMatrix",this.updateProjectionMatrix_()),t.update(d.UniformMatrix4fv,v.Float,"u_modelViewMatrix",this.updateModelViewMatrix_(this.timer.delta)),t.update(d.UniformMatrix4fv,v.Float,"u_normalMatrix",this.updateNormalMatrix_(this.modelViewMatrix))}updateUniformFlat__(){const t=this.uniforms;t.update(d.UniformMatrix4fv,v.Float,"u_projectionMatrix",q()),t.update(d.UniformMatrix4fv,v.Float,"u_modelViewMatrix",q()),t.update(d.UniformMatrix4fv,v.Float,"u_normalMatrix",q())}updateProjectionMatrix_(){const t=this.gl,e=45*Math.PI/180,i=t.drawingBufferWidth/t.drawingBufferHeight,s=.1,n=100;return ne(this.projectionMatrix,e,i,s,n),this.projectionMatrix}updateModelViewMatrix_(t){const e=this.camera;let i=this.modelViewMatrix;return i=xt(i),re(i,i,[0,0,-e.radius]),_t(i,i,e.theta+this.radians,[0,1,0]),_t(i,i,e.phi,[1,0,0]),e.mouse||(e.theta+=(0-e.theta)/20,e.phi+=(0-e.phi)/20,this.radians+=t*5e-4),i}updateNormalMatrix_(t){let e=this.normalMatrix;return e=xt(e),se(e,t),ie(e,e),e}setMode(t){let e;if(t===S.Mesh&&(e=this.cache[this.mesh],e)){this.geometry=e,this.mode=S.Mesh,this.updateUniformMesh_=this.updateUniformMesh__,this.dirty=!0;return}let i;switch(t){case S.Flat:e=new ht,this.updateUniformMesh_=this.updateUniformNoop_,this.updateUniformFlat__();break;case S.Box:e=new ae,this.updateUniformMesh_=this.updateUniformMesh__;break;case S.Sphere:e=new he,this.updateUniformMesh_=this.updateUniformMesh__;break;case S.Torus:e=new ce,this.updateUniformMesh_=this.updateUniformMesh__;break;case S.Mesh:e=new ht,this.mesh?(i=new ue,i.load(I.getResource(this.mesh,this.workpath)).then(s=>{s.createAttributes_(this.gl,this.program);const n={};n[this.mesh]=s,this.cache=n,this.geometry=s,this.dirty=!0},s=>{U.warn("GlslCanvas",s),this.mode=S.Flat})):t=S.Flat,this.updateUniformMesh_=this.updateUniformMesh__;break}e.create(this.gl,this.program),this.geometry=e,this.mode=t,this.dirty=!0}setMesh(t){this.mesh=t}}class j extends de{constructor(t,e={}){super(),this.valid=!1,this.visible=!1,this.controls=!1,this.vertexPath="",this.fragmentPath="",t&&(this.options=e,this.canvas=t,this.width=0,this.height=0,this.rect=t.getBoundingClientRect(),this.devicePixelRatio=window.devicePixelRatio||1,this.mode=e.mode||S.Flat,this.mesh=e.mesh||void 0,this.doubleSided=e.doubleSided||!1,this.defaultMesh=this.mesh,this.workpath=e.workpath,t.style.backgroundColor=e.backgroundColor||"rgba(0,0,0,0)",this.getShaders_().then(i=>{this.load().then(s=>{!this.program||(this.addListeners_(),this.onLoop())})},i=>{U.error("GlslCanvas.getShaders_.error",i)}),j.items.push(this))}getShaders_(){return new Promise(t=>{this.vertexString=this.options.vertexString||this.vertexString,this.fragmentString=this.options.fragmentString||this.fragmentString;const e=this.canvas,i={};e.hasAttribute("data-vertex-url")&&(i.vertex=e.getAttribute("data-vertex-url")),e.hasAttribute("data-fragment-url")&&(i.fragment=e.getAttribute("data-fragment-url")),e.hasAttribute("data-vertex")&&(this.vertexString=e.getAttribute("data-vertex")),e.hasAttribute("data-fragment")&&(this.fragmentString=e.getAttribute("data-fragment")),Object.keys(i).length?Promise.all(Object.keys(i).map(s=>{const n=I.getResource(i[s],this.workpath);return I.fetch(n).then(a=>{const o=I.dirname(i[s]);return s==="vertex"?(this.vertexPath=o,this.vertexString=a):(this.fragmentPath=o,this.fragmentString=a)})})).then(s=>{t([this.vertexString,this.fragmentString])}):t([this.vertexString,this.fragmentString])})}addListeners_(){this.onScroll=this.onScroll.bind(this),this.onWheel=this.onWheel.bind(this),this.onClick=this.onClick.bind(this),this.onMove=this.onMove.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.onLoop=this.onLoop.bind(this),window.addEventListener("scroll",this.onScroll),document.addEventListener("mousemove",this.onMouseMove,!1),document.addEventListener("touchmove",this.onTouchMove),this.addCanvasListeners_()}addCanvasListeners_(){this.controls=this.canvas.hasAttribute("controls"),this.canvas.addEventListener("wheel",this.onWheel),this.canvas.addEventListener("click",this.onClick),this.canvas.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("touchstart",this.onTouchStart),this.controls&&(this.canvas.addEventListener("mouseover",this.onMouseOver),this.canvas.addEventListener("mouseout",this.onMouseOut),this.canvas.hasAttribute("data-autoplay")||this.pause())}removeCanvasListeners_(){this.canvas.removeEventListener("wheel",this.onWheel),this.canvas.removeEventListener("click",this.onClick),this.canvas.removeEventListener("mousedown",this.onMouseDown),this.canvas.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("touchstart",this.onTouchStart),this.canvas.removeEventListener("touchend",this.onTouchEnd),this.controls&&(this.canvas.removeEventListener("mouseover",this.onMouseOver),this.canvas.removeEventListener("mouseout",this.onMouseOut))}removeListeners_(){window.cancelAnimationFrame(this.rafId),window.removeEventListener("scroll",this.onScroll),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("touchmove",this.onTouchMove),this.removeCanvasListeners_()}onScroll(t){this.rect=this.canvas.getBoundingClientRect()}onWheel(t){this.camera.wheel(t.deltaY),this.dirty=this.mode!==S.Flat,this.trigger("wheel",t)}onClick(t){this.controls&&this.toggle(),this.trigger("click",t)}onDown(t,e){const i=this.rect;t=t-i.left,e=i.height-(e-i.top);const s=t*this.devicePixelRatio,n=e*this.devicePixelRatio;this.mouse.x=s,this.mouse.y=n;const a=Math.min(i.width,i.height);this.camera.down(t/a,e/a),this.trigger("down",this.mouse)}onMove(t,e){const i=this.rect;t=t-i.left,e=i.height-(e-i.top);const s=t*this.devicePixelRatio,n=e*this.devicePixelRatio;if(s!==this.mouse.x||n!==this.mouse.y){this.mouse.x=s,this.mouse.y=n;const a=Math.min(i.width,i.height);this.camera.move(t/a,e/a),this.dirty=this.mode!==S.Flat&&this.camera.mouse!==null,this.trigger("move",this.mouse)}}onUp(t){this.camera.up(),this.controls&&this.pause(),this.trigger("out",t)}onMouseDown(t){this.onDown(t.clientX,t.clientY),document.addEventListener("mouseup",this.onMouseUp),document.removeEventListener("touchstart",this.onTouchStart),document.removeEventListener("touchmove",this.onTouchMove)}onMouseMove(t){this.onMove(t.clientX,t.clientY)}onMouseUp(t){this.onUp(t)}onMouseOver(t){this.play(),this.trigger("over",t)}onMouseOut(t){this.pause(),this.trigger("out",t)}onTouchStart(t){const e=[].slice.call(t.touches).reduce((i,s)=>(i=i||new st,i.x+=s.clientX,i.y+=s.clientY,i),null);e&&this.onDown(e.x/t.touches.length,e.y/t.touches.length),this.controls&&this.play(),this.trigger("over",t),document.addEventListener("touchend",this.onTouchEnd),document.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mousemove",this.onMouseMove),this.controls&&(this.canvas.removeEventListener("mouseover",this.onMouseOver),this.canvas.removeEventListener("mouseout",this.onMouseOut))}onTouchMove(t){const e=[].slice.call(t.touches).reduce((i,s)=>(i=i||new st,i.x+=s.clientX,i.y+=s.clientY,i),null);e&&this.onMove(e.x/t.touches.length,e.y/t.touches.length)}onTouchEnd(t){this.onUp(t),document.removeEventListener("touchend",this.onTouchEnd)}onLoop(t){this.checkRender(),this.rafId=window.requestAnimationFrame(this.onLoop)}setUniform_(t,e,i={},s=null){const n=z.parseUniform(t,e,s);if(Array.isArray(n))z.isArrayOfSampler2D(n)?n.forEach(a=>this.loadTexture(a.key,a.values[0],i)):n.forEach(a=>this.uniforms.set(a.key,a.values[0]));else if(n)switch(n.type){case v.Sampler2D:this.loadTexture(t,e[0],i);break;default:this.uniforms.set(t,n)}}isVisible_(){const t=this.rect;return t.top+t.height>0&&t.top<(window.innerHeight||document.documentElement.clientHeight)}isAnimated_(){return(this.animated||this.textures.animated||this.mode!==S.Flat)&&!this.timer.paused}isDirty_(){return this.dirty||this.uniforms.dirty||this.textures.dirty}sizeDidChanged_(){const t=this.gl,e=Math.ceil(this.canvas.clientWidth),i=Math.ceil(this.canvas.clientHeight);if(this.width!==e||this.height!==i){this.width=e,this.height=i;const s=Math.ceil(e*this.devicePixelRatio),n=Math.ceil(i*this.devicePixelRatio);return this.W=s,this.H=n,this.canvas.width=s,this.canvas.height=n,Object.keys(this.buffers.values).forEach(a=>{this.buffers.values[a].resize(t,s,n)}),this.rect=this.canvas.getBoundingClientRect(),this.trigger("resize"),!0}else return!1}parseTextures_(t){const e=/uniform\s*sampler2D\s*([\w]*);(\s*\/\/\s*([\w|\:\/\/|\.|\-|\_|\?|\&|\=]*)|\s*)/gm;let i;for(;(i=e.exec(t))!==null;){const s=i[1],n=i[3];N.isTextureUrl(n)?this.textureList.push({key:s,url:n}):this.buffers.has(s)||this.textureList.push({key:s,url:null})}return this.canvas.hasAttribute("data-textures")&&this.canvas.getAttribute("data-textures").split(",").forEach((n,a)=>{const o="u_texture"+a;this.textureList.push({key:o,url:n})}),this.textureList.length>0}load(t,e){const i=p.getFragmentVertex(this.gl,t||this.fragmentString);return Promise.all([p.getIncludes(t||this.fragmentString,this.fragmentPath===""?this.workpath:this.fragmentPath),p.getIncludes(i||e||this.vertexString,this.vertexPath===""?this.workpath:this.vertexPath)]).then(s=>(this.fragmentString=s[0],this.vertexString=s[1],this.createContext_()))}getContext_(){const t=this.vertexString,e=this.fragmentString;if(this.vertexString=p.getVertex(t,e,this.mode),this.fragmentString=p.getFragment(t,e,this.mode),p.versionDiffers(this.gl,t,e)&&(this.destroyContext_(),this.swapCanvas_(),this.uniforms=new z,this.buffers=new tt,this.textures=new St,this.textureList=[]),!this.gl){const i=p.tryInferContext(t,e,this.canvas,this.options,this.options.extensions,this.options.onError);if(!i)return null;this.gl=i}return this.gl}createContext_(){const t=this.getContext_();if(!t)return!1;let e,i;try{if(p.inferPrecision(this.fragmentString),e=p.createShader(t,this.vertexString,t.VERTEX_SHADER),i=p.createShader(t,this.fragmentString,t.FRAGMENT_SHADER),i)this.valid=!0;else{const n=p.getFragment(null,null,this.mode);i=p.createShader(t,n,t.FRAGMENT_SHADER),this.valid=!1}}catch(n){return this.trigger("error",n),!1}const s=p.createProgram(t,[e,i]);if(!s)return this.trigger("error",p.lastError),!1;if(t.deleteShader(e),t.deleteShader(i),this.program=s,this.valid){try{this.buffers=tt.getBuffers(t,this.fragmentString,p.getBufferVertex(t))}catch(n){return this.valid=!1,this.trigger("error",n),!1}this.create_(),this.animated?this.canvas.classList.add("animated"):this.canvas.classList.remove("animated")}return this.trigger("load",this),this.valid}create_(){this.parseMode_(),this.parseMesh_(),super.create_(),this.createBuffers_(),this.createTextures_()}parseMode_(){if(this.canvas.hasAttribute("data-mode")){const t=this.canvas.getAttribute("data-mode");["flat","box","sphere","torus","mesh"].indexOf(t)!==-1&&(this.mode=t)}}parseMesh_(){if(this.canvas.hasAttribute("data-mesh")){const t=this.canvas.getAttribute("data-mesh");t.indexOf(".obj")!==-1&&(this.mesh=this.defaultMesh=t)}}createBuffers_(){Object.keys(this.buffers.values).forEach(t=>{const e=this.buffers.values[t];this.uniforms.create(d.Uniform1i,v.Sampler2D,e.key,[e.input.index])})}createTextures_(){this.parseTextures_(this.fragmentString)&&(this.textureList.filter(e=>e.url).forEach(e=>{this.setTexture(e.key,e.url,e.options)}),this.textureList=[])}update_(){super.update_(),this.updateBuffers_(),this.updateTextures_()}updateBuffers_(){Object.keys(this.buffers.values).forEach(t=>{const e=this.buffers.values[t];this.uniforms.update(d.Uniform1i,v.Sampler2D,e.key,[e.input.index])})}updateTextures_(){const t=this.gl;Object.keys(this.textures.values).forEach(e=>{const i=this.textures.values[e];i.tryUpdate(t),this.uniforms.update(d.Uniform1i,v.Sampler2D,i.key,[i.index])})}destroyContext_(){const t=this.gl;t.useProgram(null),this.program&&t.deleteProgram(this.program),Object.keys(this.buffers.values).forEach(e=>{this.buffers.values[e].destroy(t)}),Object.keys(this.textures.values).forEach(e=>{this.textures.values[e].destroy(t)}),this.buffers=null,this.textures=null,this.uniforms=null,this.program=null,this.gl=null}swapCanvas_(){const t=this.canvas,e=t.cloneNode();t.parentNode.replaceChild(e,t),this.canvas=e,this.addCanvasListeners_()}destroy(){this.removeListeners_(),this.destroyContext_(),this.animated=!1,this.valid=!1;const t=j.items.indexOf(this);t!==-1&&j.items.splice(t,1)}loadTexture(t,e,i={}){this.valid?this.textures.createOrUpdate(this.gl,t,e,this.buffers.count,i,this.options.workpath).then(s=>{const n=s.index,a=this.uniforms.createTexture(t,n);a.texture=s;const o=t.indexOf("[")!==-1?t.replace("[","Resolution["):t+"Resolution";return this.uniforms.create(d.Uniform2f,v.Float,o,[s.width,s.height]),s},s=>{const n=Array.isArray(s.path)?s.path.map(a=>a.error?a.error.message:"").join(", "):s.message;U.error("GlslCanvas.loadTexture.error",t,e,n),this.trigger("textureError",{key:t,urlElementOrData:e,message:n})}):this.textureList.push({key:t,url:e,options:i})}setTexture(t,e,i={}){return this.setUniform_(t,[e],i)}setUniform(t,...e){return this.setUniform_(t,e)}setUniformOfInt(t,e){return this.setUniform_(t,e,null,v.Int)}setUniforms(t){Object.keys(t).forEach(e=>{this.setUniform(e,t[e])})}pause(){this.valid&&(this.timer.pause(),this.canvas.classList.add("paused"),this.trigger("pause"))}play(){this.valid&&(this.timer.play(),this.canvas.classList.remove("paused"),this.trigger("play"))}toggle(){this.valid&&(this.timer.paused?this.play():this.pause())}checkRender(){this.isVisible_()&&(this.sizeDidChanged_()||this.isDirty_()||this.isAnimated_())?(this.render(),this.canvas.classList.add("playing")):this.canvas.classList.remove("playing")}}j.items=[];function me(r,t){return j.items.find(e=>e.canvas===r)||new j(r,t)}function ve(){return[].slice.call(document.getElementsByClassName("glsl-canvas")).filter(t=>t instanceof HTMLCanvasElement).map(t=>me(t))}typeof window=="object"&&document.addEventListener("DOMContentLoaded",()=>{ve()});const Q=class extends j{constructor(e,{fragmentString:i,vertexString:s,...n}={}){typeof s=="string"&&(s=Q.extend(s,"precision highp float;")),typeof i=="string"&&(i=Q.extend(i,"precision highp float;"));super(e,{powerPreference:"high-performance",...n,vertexString:s,fragmentString:i});et(this,"time",0);et(this,"pointer",{x:0,y:0});Gt(()=>this.destroy()),Ot(()=>this.time=Math.round(100*this.time+1)/100),this.on("render",()=>this.setUniform("time",this.time)),It("pointermove",a=>{a.preventDefault(),this.pointer.x=a.clientX-this.rect.x,this.pointer.y=a.clientY-this.rect.y})}static extend(e,i,s){return!s&&e.includes(i)?e:e.startsWith(this.v3pragma)?`${this.v3pragma}${i}${e.slice(this.v3pragma.length)}`:i+e}static extendMain(e,i,s){if(!s&&e.includes(i))return e;let n=e.indexOf("void main() {");return n===-1?e:(n+=13,`${e.slice(0,n)}${i}${e.slice(n)}`)}setPixelRatio(e){const i=this.devicePixelRatio,s=this.devicePixelRatio=e;this.canvas.width*=s/i,this.canvas.height*=s/i,this.checkRender()}load(e,i){return typeof i=="string"&&(i=Q.extend(i,"precision highp float;")),typeof e=="string"&&(e=Q.extend(e,"precision highp float;")),super.load(e,i)}useUniform(e,i){return lt(()=>{const{value:s}=i;Array.isArray(s)?this.setUniform(e,...s):this.setUniform(e,s)})}useUniformOfInt(e,i){return lt(()=>{const{value:s}=i;Array.isArray(s)?this.setUniformOfInt(e,s):this.setUniformOfInt(e,[s])})}};let ot=Q;et(ot,"v3pragma",`#version 300 es
`);export{ot as W};
