var Ct=Object.defineProperty,Vt=Object.defineProperties;var Nt=Object.getOwnPropertyDescriptors;var et=Object.getOwnPropertySymbols;var dt=Object.prototype.hasOwnProperty,mt=Object.prototype.propertyIsEnumerable;var nt=(s,t,e)=>t in s?Ct(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vt=(s,t)=>{for(var e in t||(t={}))dt.call(t,e)&&nt(s,e,t[e]);if(et)for(var e of et(t))mt.call(t,e)&&nt(s,e,t[e]);return s},pt=(s,t)=>Vt(s,Nt(t));var xt=(s,t)=>{var e={};for(var i in s)dt.call(s,i)&&t.indexOf(i)<0&&(e[i]=s[i]);if(s!=null&&et)for(var i of et(s))t.indexOf(i)<0&&mt.call(s,i)&&(e[i]=s[i]);return e};var _t=(s,t,e)=>(nt(s,typeof t!="symbol"?t+"":t,e),e);import{an as Et,ap as zt}from"./index.70e8d914.js";const Pt=`
#ifdef GL_ES
precision mediump float;
#endif

attribute vec4 a_position;
attribute vec4 a_normal;
attribute vec2 a_texcoord;
attribute vec4 a_color;

varying vec4 v_position;
varying vec4 v_normal;
varying vec2 v_texcoord;
varying vec4 v_color;
`,ut=`
#ifdef GL_ES
precision mediump float;
#endif

varying vec4 v_position;
varying vec4 v_normal;
varying vec2 v_texcoord;
varying vec4 v_color;
`,Ot=`#version 300 es

precision mediump float;

in vec4 a_position;
in vec4 a_normal;
in vec2 a_texcoord;
in vec4 a_color;

out vec4 v_position;
out vec4 v_normal;
out vec2 v_texcoord;
out vec4 v_color;
`,ft=`#version 300 es

precision mediump float;

in vec4 v_position;
in vec4 v_normal;
in vec2 v_texcoord;
in vec4 v_color;

out vec4 outColor;
`,k=`
uniform mat4 u_projectionMatrix;
uniform mat4 u_modelViewMatrix;
uniform mat4 u_normalMatrix;

uniform vec2 u_resolution;
uniform float u_time;
`,It=`
void main() {
	v_position = a_position;
	v_normal = a_normal;
	v_texcoord = a_texcoord;
	v_color = a_color;
	gl_Position = a_position;
}
`,Gt=`
void main(void) {
	v_position = u_projectionMatrix * u_modelViewMatrix * a_position;
	v_normal = u_normalMatrix * a_normal;
	v_texcoord = a_texcoord;
	v_color = a_color;
	gl_Position = v_position;
}
`,kt=`
void main() {
	vec2 st = gl_FragCoord.xy / u_resolution.xy;
	st.x *= u_resolution.x / u_resolution.y;
	vec3 color = vec3(
		abs(cos(u_time * 0.1)) * st.y,
		abs(cos(u_time * 0.2)) * st.y,
		abs(sin(u_time)) * st.y
	);
	gl_FragColor = vec4(color, 1.0);
}
`,Xt=`
void main() {
	vec2 st = gl_FragCoord.xy / u_resolution.xy;
	st.x *= u_resolution.x / u_resolution.y;
	vec3 color = vec3(
		abs(cos(u_time * 0.1)) * st.y,
		abs(cos(u_time * 0.2)) * st.y,
		abs(sin(u_time)) * st.y
	);
	outColor = vec4(color, 1.0);
}
`,Ht=`
void main() {
	vec2 uv = v_texcoord;
	vec3 color = vec3(
		abs(cos(u_time * 0.1)) * uv.y,
		abs(cos(u_time * 0.2)) * uv.y,
		abs(sin(u_time)) * uv.y
	);
	float incidence = max(dot(v_normal.xyz, vec3(0.0, 1.0, 0.0)), 0.0);
	vec3 light = vec3(0.2) + (vec3(1.0) * incidence);
	gl_FragColor = vec4(v_color.rgb * color * light, 1.0);
}
`,jt=`
void main() {
	vec2 uv = v_texcoord;
	vec3 color = vec3(
		abs(cos(u_time * 0.1)) * uv.y,
		abs(cos(u_time * 0.2)) * uv.y,
		abs(sin(u_time)) * uv.y
	);
	float incidence = max(dot(v_normal.xyz, vec3(0.0, 1.0, 0.0)), 0.0);
	vec3 light = vec3(0.2) + (vec3(1.0) * incidence);
	outColor = vec4(v_color.rgb * color * light, 1.0);
}
`,Yt=`
void main(){
	gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
}`,$t=`
void main() {
	outColor = vec4(0.0, 0.0, 0.0, 1.0);
}
`,bt=Pt+k+Gt,Tt=Ot+k+Gt,qt=ut+k+kt,Kt=ft+k+Xt,Jt=ut+k+Ht,Qt=ft+k+jt,Zt=Pt+k+It,te=Ot+k+It,ee=ut+k+Yt,ie=ft+k+$t;class I{static fetch(t){return new Promise(function(e,i){const r=new XMLHttpRequest;r.onload=function(){e(r.response||r.responseText)},r.onerror=function(n){console.log("Common.error",n),i(new Error(`Network request failed for url ${t}`))},r.ontimeout=function(n){i(new Error(`Network request failed for url ${t}`))},r.onabort=function(){i(new Error("Aborted"))},r.open("GET",t,!0),r.send(null)})}static getResource(t,e=""){return t.indexOf(":/")===-1?I.join(e,t):t}static join(...t){let e=[];return t.forEach(i=>{i.indexOf("/")===0&&(e=[]),I.comps(i).forEach(n=>{switch(n){case".":break;case"..":e.pop();break;default:e.push(n)}})}),e.join("/")}static dirname(t){const e=I.comps(t);return e.pop(),e.join("/")}static comps(t){return t.replace(/\/$/,"").split(/\/+/)}}var Q;(function(s){s[s.None=0]="None",s[s.Error=1]="Error",s[s.Warn=2]="Warn",s[s.Log=3]="Log"})(Q||(Q={}));class U{static log(...t){U.enabled&&U.level>=Q.Log&&console.log(...t)}static warn(...t){U.enabled&&U.level>=Q.Warn&&console.warn(...t)}static error(...t){U.enabled&&U.level>=Q.Error&&console.error(...t)}}U.level=Q.Warn;U.enabled=!0;var V;(function(s){s.WebGl="webgl",s.WebGl2="webgl2"})(V||(V={}));var ht;(function(s){s.LowP="lowp",s.MediumP="mediump",s.HighP="highp"})(ht||(ht={}));var S;(function(s){s.Flat="flat",s.Box="box",s.Sphere="sphere",s.Torus="torus",s.Mesh="mesh"})(S||(S={}));const At={webgl:{flat:{vertex:bt,fragment:qt},mesh:{vertex:bt,fragment:Jt}},webgl2:{flat:{vertex:Tt,fragment:Kt},mesh:{vertex:Tt,fragment:Qt}}};var K;(function(s){s[s.BrowserSupport=1]="BrowserSupport",s[s.Other=2]="Other"})(K||(K={}));class se{}class p{static getContext_(t,e){const i=["webgl","experimental-webgl"];let r=null;for(let n=0;n<i.length;++n)try{r=t.getContext(i[n],e)}catch{if(r)break}return r}static getContext2_(t,e){let i=null;try{i=t.getContext("webgl2",e)}catch{}return i}static getFragmentVertex(t,e){let i;if(e){const r=p.inferVersion(e);r===V.WebGl2&&(e=e.replace(/^\#version\s*300\s*es.*?\n/,"")),/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*VERTEX)(?:\s*\))|(?:#ifdef)(?:\s*VERTEX)(?:\s*))/gm.exec(e)!==null&&(i=r===V.WebGl2?`#version 300 es
#define VERTEX
${e}`:`#define VERTEX
${e}`)}return i}static getIncludes(t,e=""){if(t===void 0)return Promise.resolve(t);const i=/#include\s*['|"](.*.glsl)['|"]/gm,r=[];let n=0,a;for(;(a=i.exec(t))!==null;){r.push(Promise.resolve(t.slice(n,a.index))),n=a.index+a[0].length;const o=a[1],h=I.getResource(o,e),u=o.indexOf(":/")===-1?I.dirname(h):"";r.push(I.fetch(h).then(f=>p.getIncludes(f,u)))}return r.push(Promise.resolve(t.slice(n))),Promise.all(r).then(o=>o.join(""))}static isWebGl(t){return t instanceof WebGLRenderingContext}static isWebGl2(t){return window.WebGL2RenderingContext&&t instanceof WebGL2RenderingContext}static inferVersion(t,e){const i=t||e;return i&&i.indexOf("#version 300 es")===0?V.WebGl2:V.WebGl}static inferPrecision(t){const e=t.match(/precision\s+(.+)\s+float/);return e&&e.length>1&&(p.precision=e[1]),p.precision}static versionDiffers(t,e,i){if(t){const r=this.isWebGl2(t)?V.WebGl2:V.WebGl;return p.inferVersion(e,i)!==r}else return!1}static getBufferVertex(t){return this.isWebGl2(t)?te:Zt}static getVertex(t,e,i=S.Flat){if(t)return t;{const r=this.inferVersion(t,e);return At[r][i===S.Flat?"flat":"mesh"].vertex}}static getFragment(t,e,i=S.Flat){if(e)return e;{const r=this.inferVersion(t,e);return At[r][i===S.Flat?"flat":"mesh"].fragment}}static tryInferContext(t,e,i,r,n=[],a){function o(u,f){if(typeof a=="function")a(u);else{const c=i.parentNode;c&&(c.innerHTML=`<div class="glsl-canvas--error">${f}</div>`)}}if(!WebGLRenderingContext)return o(K.BrowserSupport,`This page requires a browser that supports WebGL.<br/>
			<a href="http://get.webgl.org">Click here to upgrade your browser.</a>`),null;const h=p.inferContext(t,e,i,r);if(!h)o(K.Other,`It does not appear your computer can support WebGL.<br/>
			<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`);else{!this.isWebGl2(h)&&n.indexOf("OES_standard_derivatives")===-1&&n.push("OES_standard_derivatives");const u=h.getSupportedExtensions();n.forEach(f=>{u.indexOf(f)!==-1?h.getExtension(f):U.warn(`GlslCanvas ${f} not supported`)})}return h}static tryGetContext(t,e,i){function r(a,o){if(typeof i=="function")i(a);else{const h=t.parentNode;h&&(h.innerHTML=`<div class="glsl-canvas--error">${o}</div>`)}}if(!WebGLRenderingContext)return r(K.BrowserSupport,`This page requires a browser that supports WebGL.<br/>
			<a href="http://get.webgl.org">Click here to upgrade your browser.</a>`),null;const n=p.getContext_(t,e);return n?n.getExtension("OES_standard_derivatives"):r(K.Other,`It does not appear your computer can support WebGL.<br/>
			<a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`),n}static inferContext(t,e,i,r){return this.inferVersion(t,e)===V.WebGl2?this.getContext2_(i,r):this.getContext_(i,r)}static createShader(t,e,i,r=0){const n=t.createShader(i);if(e=e.replace(/precision\s+(.+)\s+float/,`precision ${p.precision} float`),t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw p.lastError=t.getShaderInfoLog(n),U.error(`*** Error compiling shader: ${p.lastError}`),t.deleteShader(n),{shader:n,source:e,type:i,error:p.lastError,offset:r};return n}static createProgram(t,e,i,r){const n=t.createProgram();for(let o=0;o<e.length;++o)t.attachShader(n,e[o]);if(i&&r)for(let o=0;o<i.length;++o)t.bindAttribLocation(n,r?r[o]:o,i[o]);return t.linkProgram(n),t.validateProgram(n),t.getProgramParameter(n,t.LINK_STATUS)?(t.useProgram(n),n):(p.lastError=t.getProgramInfoLog(n),U.error(`Error in program linking: ${p.lastError}`),t.deleteProgram(n),null)}static createVertexBuffers(t,e){const i=new se,r=t.getAttribLocation(e,"a_texcoord");i.texcoord=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.texcoord),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0);const n=t.getAttribLocation(e,"a_position");return i.position=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.position),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(n),t.vertexAttribPointer(n,2,t.FLOAT,!1,0,0),i}}p.precision=ht.MediumP;p.lastError="";class re{}class lt{constructor(){this.values=new re}has(t){return t in this.values}set(t,e){this.values[t]=e}get(t){return this.values[t]}forEach(t){let e=0;Object.keys(this.values).forEach(i=>{t(this.values[i],e,this.values),e++})}reduce(t,e){let i=e,r=0;return Object.keys(this.values).forEach(n=>{i=t(i,this.values[n],r,this.values),r++}),i}}class O{constructor(t){t&&(Object.assign(this,t),this.positions&&(this.size=this.positions.length/3))}create(t,e){this.createData_(),this.createAttributes_(t,e)}createBufferData_(t,e,i){const r=t.createBuffer();return t.bindBuffer(e,r),t.bufferData(e,i,t.STATIC_DRAW),r}createAttribLocation_(t,e,i,r,n){const a=t.getAttribLocation(e,i);return t.enableVertexAttribArray(a),t.vertexAttribPointer(a,r,n,!1,0,0),a}createAttributes_(t,e){this.positions&&(this.positionBuffer=this.createBufferData_(t,t.ARRAY_BUFFER,new Float32Array(this.positions)),this.positionLocation=this.createAttribLocation_(t,e,"a_position",this.positions.length/this.size,t.FLOAT),t.bindAttribLocation(e,this.positionLocation,"a_position")),this.texcoords&&(this.texcoordBuffer=this.createBufferData_(t,t.ARRAY_BUFFER,new Float32Array(this.texcoords)),this.texcoordLocation=this.createAttribLocation_(t,e,"a_texcoord",this.texcoords.length/this.size,t.FLOAT),t.bindAttribLocation(e,this.texcoordLocation,"a_texcoord")),this.normals&&(this.normalBuffer=this.createBufferData_(t,t.ARRAY_BUFFER,new Float32Array(this.normals)),this.normalLocation=this.createAttribLocation_(t,e,"a_normal",this.normals.length/this.size,t.FLOAT),t.bindAttribLocation(e,this.normalLocation,"a_normal")),this.colors&&(this.colorBuffer=this.createBufferData_(t,t.ARRAY_BUFFER,new Float32Array(this.colors)),this.colorLocation=this.createAttribLocation_(t,e,"a_color",this.colors.length/this.size,t.FLOAT),t.bindAttribLocation(e,this.colorLocation,"a_color"))}attachAttributes_(t,e){let i;this.positions&&(i=t.getAttribLocation(e,"a_position"),t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.vertexAttribPointer(i,this.positions.length/this.size,t.FLOAT,!1,0,0)),this.texcoords&&(i=t.getAttribLocation(e,"a_texcoord"),t.enableVertexAttribArray(this.texcoordLocation),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer),t.vertexAttribPointer(this.texcoordLocation,this.texcoords.length/this.size,t.FLOAT,!1,0,0)),this.normals&&(i=t.getAttribLocation(e,"a_normal"),t.enableVertexAttribArray(this.normalLocation),t.bindBuffer(t.ARRAY_BUFFER,this.normalBuffer),t.vertexAttribPointer(this.normalLocation,this.normals.length/this.size,t.FLOAT,!1,0,0)),this.colors&&(i=t.getAttribLocation(e,"a_color"),t.enableVertexAttribArray(this.colorLocation),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.vertexAttribPointer(this.colorLocation,this.colors.length/this.size,t.FLOAT,!1,0,0))}bindAttributes_(t,e){this.positions&&t.bindAttribLocation(e,this.positionLocation,"a_position"),this.texcoords&&t.bindAttribLocation(e,this.texcoordLocation,"a_texcoord"),this.normals&&t.bindAttribLocation(e,this.normalLocation,"a_normal"),this.colors&&t.bindAttribLocation(e,this.colorLocation,"a_color")}createData_(){this.positions=[],this.normals=[],this.texcoords=[],this.colors=[],this.size=0}static fromIndices(t,e,i){const r=[];return t.forEach(n=>{r.push.apply(r,e.slice(n*i,n*i+i))}),r}}class ct extends O{createData_(){this.size=6,this.positions=[-1,-1,0,1,-1,0,1,1,0,-1,-1,0,1,1,0,-1,1,0],this.texcoords=[0,0,1,0,1,1,0,0,1,1,0,1],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],this.colors=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}var H;(function(s){s[s.FLOAT=0]="FLOAT",s[s.HALF_FLOAT=1]="HALF_FLOAT"})(H||(H={}));class F{constructor(t,e,i,r){const n=t.createFramebuffer(),a=F.getTexture(t,e,i,r);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.texture=a,this.buffer=n,this.BW=e,this.BH=i,this.index=r}static getFloatType(t){let e;return p.isWebGl2(t)&&(e=t.getExtension("EXT_color_buffer_float"),e)||(e=t.getExtension("OES_texture_float"),e)?t.FLOAT:null}static getHalfFloatType(t){let e;return p.isWebGl2(t)&&(e=t.getExtension("EXT_color_buffer_half_float")||t.getExtension("EXT_color_buffer_float"),e)?t.HALF_FLOAT:(e=t.getExtension("OES_texture_half_float"),e&&e.HALF_FLOAT_OES||null)}static getInternalFormat(t){return p.isWebGl2(t)?t.RGBA16F:t.RGBA}static getType(t){let e;return F.type===H.HALF_FLOAT?(e=F.getHalfFloatType(t),e||(F.type=H.FLOAT,F.getType(t))):(e=F.getFloatType(t),e||(F.type=H.HALF_FLOAT,F.getType(t)))}static getTexture(t,e,i,r){const n=F.getInternalFormat(t),a=t.RGBA,o=F.getType(t),h=t.createTexture();return t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,h),t.texImage2D(t.TEXTURE_2D,0,n,e,i,0,a,o,null),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE?(F.type===H.FLOAT?F.type=H.HALF_FLOAT:F.type=H.FLOAT,F.getTexture(t,e,i,r)):h}resize(t,e,i){if(e!==this.BW||i!==this.BH){const r=this.buffer,n=this.texture,a=this.index;t.bindFramebuffer(t.FRAMEBUFFER,r);const o=t.checkFramebufferStatus(t.FRAMEBUFFER),h=Math.min(e,this.BW),u=Math.min(i,this.BH);let f,c=F.getType(t);o===t.FRAMEBUFFER_COMPLETE&&(f=new Float32Array(h*u*4),t.readPixels(0,0,h,u,t.RGBA,c,f)),t.bindFramebuffer(t.FRAMEBUFFER,null);const m=a+1,T=F.getTexture(t,e,i,m);c=F.getType(t),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),f&&t.texSubImage2D(t.TEXTURE_2D,0,0,0,h,u,t.RGBA,c,f);const E=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteTexture(n),t.activeTexture(t.TEXTURE0+a),t.bindTexture(t.TEXTURE_2D,T),this.index=a,this.texture=T,this.buffer=E,this.BW=e,this.BH=i}}}F.type=H.HALF_FLOAT;class ne{constructor(t,e,i,r){this.isValid=!1,this.index=t,this.key=e,this.vertexString=i,this.fragmentString=r,this.geometry=new ct}create(t,e,i){const r=p.createShader(t,this.vertexString,t.VERTEX_SHADER);let n=p.createShader(t,this.fragmentString,t.FRAGMENT_SHADER,1);n?this.isValid=!0:(n=p.createShader(t,p.isWebGl2(t)?ie:ee,t.FRAGMENT_SHADER),this.isValid=!1);const a=p.createProgram(t,[r,n]);if(!a){this.isValid=!1,t.deleteShader(r),t.deleteShader(n);return}this.geometry.create(t,a),t.deleteShader(r),t.deleteShader(n);const o=new F(t,e,i,this.index+0),h=new F(t,e,i,this.index+2);this.program=a,this.input=o,this.output=h}render(t,e,i){t.useProgram(this.program),t.bindFramebuffer(t.FRAMEBUFFER,this.output.buffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.output.texture,0),t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE&&(t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)),t.viewport(0,0,e,i),t.drawArrays(t.TRIANGLES,0,this.geometry.size);const n=this.input;this.input=this.output,this.output=n}resize(t,e,i){t.useProgram(this.program),t.viewport(0,0,e,i),this.input.resize(t,e,i),this.output.resize(t,e,i)}destroy(t){t.deleteProgram(this.program),this.program=null,this.input=null,this.output=null}}class tt extends lt{get count(){return Object.keys(this.values).length*4}static getBuffers(t,e,i){const r=new tt;let n=0;if(e){p.isWebGl2(t)&&(e=e.replace(/^\#version\s*300\s*es\s*\n/,""));const a=/(?:^\s*)((?:#if|#elif)(?:\s*)(defined\s*\(\s*BUFFER_)(\d+)(?:\s*\))|(?:#ifdef)(?:\s*BUFFER_)(\d+)(?:\s*))/gm;let o;for(;(o=a.exec(e))!==null;){const h=o[3]||o[4],u="u_buffer"+h,f=p.isWebGl2(t)?`#version 300 es
#define BUFFER_${h}
${e}`:`#define BUFFER_${h}
${e}`,c=new ne(n,u,i,f);if(c.create(t,t.drawingBufferWidth,t.drawingBufferHeight),c.program)r.set(u,c);else throw`buffer error ${u}`;n+=4}}return r}}class st{constructor(t=0,e=0){this.isVector2=!0,this.x=t,this.y=e}copy(t){return this.x=t.x,this.y=t.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){return this.divideScalar(this.length()||1)}divideScalar(t){return this.multiplyScalar(1/t)}multiplyScalar(t){return this.x*=t,this.y*=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}}class D{constructor(t=0,e=0,i=0){this.isVector3=!0,this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){return this.divideScalar(this.length()||1)}divideScalar(t){return this.multiplyScalar(1/t)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}crossVectors(t,e){var i=t.x,r=t.y,n=t.z,a=e.x,o=e.y,h=e.z;return this.x=r*h-n*o,this.y=n*a-i*h,this.z=i*o-r*a,this}}const oe=Math.PI,$=oe/180;class rt extends D{constructor(t,e,i){super(),this.position=new D,this.value=new Float32Array([0,0,0]),this.mouse=null,this.dirty=!1,this.theta=(t||0)*$,this.phi=(e||0)*$,this.radius=i||6}down(t,e){this.mouse=new st(t,e)}move(t,e){const i=this.mouse;if(i&&(i.x!==t||i.y!==e)){const r=(t-i.x)*180*$,n=(e-i.y)*180*$;i.x=t,i.y=e,this.theta+=r,this.phi=Math.max(-60*$,Math.min(60*$,this.phi+n))}}up(){this.mouse=null}wheel(t){this.radius=Math.max(4,Math.min(10,this.radius+t*.02))}static fromVector(t){const e=t.length(),i=Math.acos(t.y/e),r=Math.atan(t.x/t.z);return new rt(i,r,e)}static toArray(t){const e=Math.sin(t.phi)*t.radius,i=e*Math.sin(t.theta),r=Math.cos(t.phi)*t.radius,n=e*Math.cos(t.theta);return[i,r,n]}}var ae=1e-6,yt=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,t=arguments.length;t--;)s+=arguments[t]*arguments[t];return Math.sqrt(s)});function q(){var s=new yt(16);return yt!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=0,s[12]=0,s[13]=0,s[14]=0),s[0]=1,s[5]=1,s[10]=1,s[15]=1,s}function Mt(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function he(s,t){if(s===t){var e=t[1],i=t[2],r=t[3],n=t[6],a=t[7],o=t[11];s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=e,s[6]=t[9],s[7]=t[13],s[8]=i,s[9]=n,s[11]=t[14],s[12]=r,s[13]=a,s[14]=o}else s[0]=t[0],s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=t[1],s[5]=t[5],s[6]=t[9],s[7]=t[13],s[8]=t[2],s[9]=t[6],s[10]=t[10],s[11]=t[14],s[12]=t[3],s[13]=t[7],s[14]=t[11],s[15]=t[15];return s}function ce(s,t){var e=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],u=t[7],f=t[8],c=t[9],m=t[10],T=t[11],E=t[12],M=t[13],l=t[14],x=t[15],w=e*o-i*a,_=e*h-r*a,b=e*u-n*a,A=i*h-r*o,g=i*u-n*o,L=r*u-n*h,R=f*M-c*E,P=f*l-m*E,G=f*x-T*E,B=c*l-m*M,W=c*x-T*M,C=m*x-T*l,y=w*C-_*W+b*B+A*G-g*P+L*R;return y?(y=1/y,s[0]=(o*C-h*W+u*B)*y,s[1]=(r*W-i*C-n*B)*y,s[2]=(M*L-l*g+x*A)*y,s[3]=(m*g-c*L-T*A)*y,s[4]=(h*G-a*C-u*P)*y,s[5]=(e*C-r*G+n*P)*y,s[6]=(l*b-E*L-x*_)*y,s[7]=(f*L-m*b+T*_)*y,s[8]=(a*W-o*G+u*R)*y,s[9]=(i*G-e*W-n*R)*y,s[10]=(E*g-M*b+x*w)*y,s[11]=(c*b-f*g-T*w)*y,s[12]=(o*P-a*B-h*R)*y,s[13]=(e*B-i*P+r*R)*y,s[14]=(M*_-E*A-l*w)*y,s[15]=(f*A-c*_+m*w)*y,s):null}function ue(s,t,e){var i=e[0],r=e[1],n=e[2],a,o,h,u,f,c,m,T,E,M,l,x;return t===s?(s[12]=t[0]*i+t[4]*r+t[8]*n+t[12],s[13]=t[1]*i+t[5]*r+t[9]*n+t[13],s[14]=t[2]*i+t[6]*r+t[10]*n+t[14],s[15]=t[3]*i+t[7]*r+t[11]*n+t[15]):(a=t[0],o=t[1],h=t[2],u=t[3],f=t[4],c=t[5],m=t[6],T=t[7],E=t[8],M=t[9],l=t[10],x=t[11],s[0]=a,s[1]=o,s[2]=h,s[3]=u,s[4]=f,s[5]=c,s[6]=m,s[7]=T,s[8]=E,s[9]=M,s[10]=l,s[11]=x,s[12]=a*i+f*r+E*n+t[12],s[13]=o*i+c*r+M*n+t[13],s[14]=h*i+m*r+l*n+t[14],s[15]=u*i+T*r+x*n+t[15]),s}function wt(s,t,e,i){var r=i[0],n=i[1],a=i[2],o=Math.hypot(r,n,a),h,u,f,c,m,T,E,M,l,x,w,_,b,A,g,L,R,P,G,B,W,C,y,Z;return o<ae?null:(o=1/o,r*=o,n*=o,a*=o,h=Math.sin(e),u=Math.cos(e),f=1-u,c=t[0],m=t[1],T=t[2],E=t[3],M=t[4],l=t[5],x=t[6],w=t[7],_=t[8],b=t[9],A=t[10],g=t[11],L=r*r*f+u,R=n*r*f+a*h,P=a*r*f-n*h,G=r*n*f-a*h,B=n*n*f+u,W=a*n*f+r*h,C=r*a*f+n*h,y=n*a*f-r*h,Z=a*a*f+u,s[0]=c*L+M*R+_*P,s[1]=m*L+l*R+b*P,s[2]=T*L+x*R+A*P,s[3]=E*L+w*R+g*P,s[4]=c*G+M*B+_*W,s[5]=m*G+l*B+b*W,s[6]=T*G+x*B+A*W,s[7]=E*G+w*B+g*W,s[8]=c*C+M*y+_*Z,s[9]=m*C+l*y+b*Z,s[10]=T*C+x*y+A*Z,s[11]=E*C+w*y+g*Z,t!==s&&(s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15]),s)}function fe(s,t,e,i,r){var n=1/Math.tan(t/2),a;return s[0]=n/e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=n,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,r!=null&&r!==1/0?(a=1/(i-r),s[10]=(r+i)*a,s[14]=2*r*i*a):(s[10]=-1,s[14]=-2*i),s}class le{constructor(){this.delay=0,this.current=0,this.delta=0,this.paused=!1,this.start=this.previous=this.now()}now(){return performance.now()}play(){if(this.previous){const t=this.now();this.delay+=t-this.previous,this.previous=t}this.paused=!1}pause(){this.paused=!0}next(){const t=this.now();return this.delta=t-this.previous,this.current=t-this.start-this.delay,this.previous=t,this}}class gt{constructor(t,e){this.event=t,this.callback=e}}class Bt{constructor(){this.listeners=new Set}logListeners(){this.listeners.forEach(t=>U.log(t))}subscribe(t){this.listeners.add(t)}unsubscribe(t){this.listeners.delete(t)}unsubscribeAll(){this.listeners.clear()}on(t,e){return this.listeners.add(new gt(t,e)),this}off(t,e){return e?this.listeners.delete(new gt(t,e)):this.listeners.forEach(i=>{i.event===t&&this.listeners.delete(i)}),this}trigger(t,...e){return this.listeners.forEach(i=>{i.event===t&&typeof i.callback=="function"&&i.callback(...e)}),this}}class de extends O{createData_(){this.size=36,this.positions=[-1,-1,1,1,-1,1,1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,-1,-1,1,1,-1,1,-1],this.texcoords=[0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0];const t=[[1,1,1,1],[1,0,0,1],[0,1,0,1],[0,0,1,1],[1,1,0,1],[1,0,1,1]];let e=[];for(var i=0;i<t.length;++i){const r=t[i];e=e.concat(r,r,r,r,r,r)}this.colors=e}}class me extends O{createData_(){const n=Math.PI*2,a=0,o=Math.PI,h=new D,u=new D,f=[],c=[],m=[],T=[],E=[];let M=Math.min(a+o,Math.PI),l,x,w=0,_=[];for(x=0;x<=60;x++){let b=[],A=x/60,g=0;for(x==0&&a==0?g=.5/80:x==60&&M==Math.PI&&(g=-.5/80),l=0;l<=80;l++){let L=l/80;h.x=-1.4*Math.cos(0+L*n)*Math.sin(a+A*o),h.y=1.4*Math.cos(a+A*o),h.z=1.4*Math.sin(0+L*n)*Math.sin(a+A*o),c.push(h.x,h.y,h.z),u.copy(h).normalize(),m.push(u.x,u.y,u.z);const R=L+g,P=1-A;T.push(R,P),E.push(1,1,1,1),b.push(w++)}_.push(b)}for(x=0;x<60;x++)for(l=0;l<80;l++){const b=_[x][l+1],A=_[x][l],g=_[x+1][l],L=_[x+1][l+1];(x!==0||a>0)&&f.push(b,A,L),(x!==60-1||M<Math.PI)&&f.push(A,g,L)}this.size=f.length,this.positions=O.fromIndices(f,c,3),this.texcoords=O.fromIndices(f,T,2),this.normals=O.fromIndices(f,m,3),this.colors=O.fromIndices(f,E,4)}}class ve extends O{createData_(){const o=[],h=[],u=[],f=[],c=[],m=new D,T=new D,E=new D,M=new D,l=new D,x=new D,w=new D;for(let _=0;_<=200;++_){const b=_/200*2*Math.PI*2;this.calculatePositionOnCurve(b,2,3,1,E),this.calculatePositionOnCurve(b+.01,2,3,1,M),x.subVectors(M,E),w.addVectors(M,E),l.crossVectors(x,w),w.crossVectors(l,x),l.normalize(),w.normalize();for(let A=0;A<=40;++A){const g=A/40*Math.PI*2,L=-.25*Math.cos(g),R=.25*Math.sin(g);m.x=E.x+(L*w.x+R*l.x),m.y=E.y+(L*w.y+R*l.y),m.z=E.z+(L*w.z+R*l.z),h.push(m.x,m.y,m.z),T.subVectors(m,E).normalize(),u.push(T.x,T.y,T.z),f.push(_/200*2*Math.round(3)),f.push(A/40),c.push(1,1,1,1)}}for(let _=1;_<=200;_++)for(let b=1;b<=40;b++){const A=41*(_-1)+(b-1),g=(40+1)*_+(b-1),L=(40+1)*_+b,R=(40+1)*(_-1)+b;o.push(A,g,R),o.push(g,L,R)}this.size=o.length,this.positions=O.fromIndices(o,h,3),this.texcoords=O.fromIndices(o,f,2),this.normals=O.fromIndices(o,u,3),this.colors=O.fromIndices(o,c,4)}calculatePositionOnCurve(t,e,i,r,n){const a=Math.cos(t),o=Math.sin(t),h=i/e*t,u=Math.cos(h);n.x=r*(2+u)*.5*a,n.y=r*(2+u)*o*.5,n.z=r*Math.sin(h)*.5}}const Lt=[[1,1,1],[1,0,0],[0,1,0],[0,0,1],[1,1,0],[0,1,1]];let ot=0;class pe{load(t){return new Promise((e,i)=>{I.fetch(t).then(r=>{const n=this.parse(r);if(n.positions.length){const a=new O(n);e(a)}else i(`ObjLoader error: empty positions ${t}`)},r=>{console.log("ObjLoader error:",r,t),i(r)})})}parseIndices(t,e,i,r,n,a){let o=0;for(;o<=t.length-3;){let h,u,f;o===0?(h=o,u=o+1,f=o+2):(h=o-1,u=o+1,f=o+2),o++;const c=[h,u,f];for(let m=0;m<c.length;m++){const T=t[c[m]][e];let E;T&&T!==NaN&&(E=r[T-1],E&&(E=E.slice(0,i),n.push.apply(n,E)))}}}parseFaces(t,e,i,r,n,a,o,h){const u=n.length;t.forEach(c=>{this.parseIndices(c,0,3,e,n,"positions"),this.parseIndices(c,2,3,i,a,"normals"),this.parseIndices(c,1,2,r,o,"texcoords")});const f=n.length-u;f>0&&(new Array(f/3).fill(0).forEach(()=>{const m=Lt[ot%Lt.length];h.push(m[0],m[1],m[2],1)}),ot++)}parse(t){let e=[],i=[],r=[],n=[];ot=0;let a=[],o=[],h=[],u=[];t.indexOf(`\r
`)!==-1&&(t=t.replace(/\r\n/g,`
`)),t=t.replace(/  /g," "),t.split(`
`).forEach((l,x)=>{if(l.indexOf("v ")===0){u.length&&(this.parseFaces(u,a,o,h,e,i,r,n),u=[]);const _=l.replace("v","").trim().split(" ").map(b=>parseFloat(b));a.push(_)}else if(l.indexOf("vn ")===0){const _=l.replace("vn","").trim().split(" ").map(A=>parseFloat(A)),b=new D(_[0],_[1],_[2]).normalize();o.push([b.x,b.y,b.z])}else if(l.indexOf("vt ")===0){const _=l.replace("vt","").trim().split(" ").map(b=>parseFloat(b));h.push(_)}else if(l.indexOf("f ")===0){const _=l.replace("f","").trim().split(" ").map(b=>{const A=b.split("/").map(g=>parseInt(g));return A.length===2&&A.push(null),A});u[u.length]=_}}),u.length&&this.parseFaces(u,a,o,h,e,i,r,n);const c={min:new D(Number.POSITIVE_INFINITY),max:new D(Number.NEGATIVE_INFINITY)};for(let l=0;l<e.length;l+=3)c.min.x=Math.min(c.min.x,e[l]),c.min.y=Math.min(c.min.y,e[l+1]),c.min.z=Math.min(c.min.z,e[l+2]),c.max.x=Math.max(c.max.x,e[l]),c.max.y=Math.max(c.max.y,e[l+1]),c.max.z=Math.max(c.max.z,e[l+2]);const m=-(c.min.x+c.max.x)/2,T=-(c.min.y+c.max.y)/2,E=-(c.min.z+c.max.z)/2;for(let l=0;l<e.length;l+=3)e[l]+=m,e[l+1]+=T,e[l+2]+=E;const M=e.reduce((l,x)=>Math.max(l,x),0);return e.forEach((l,x)=>e[x]=l/M*2),i.length||(i=e.slice()),r.length||(r=this.unrapUvw(e)),{positions:e,normals:i,texcoords:r,colors:n}}unrapUvw(t){const e=[];for(let i=0;i<t.length;i+=3){const r=new D(t[i],t[i+1],t[i+2]);r.normalize();const n=Math.asin(-r.y),a=Math.atan2(r.x,r.z),o=.5+n/Math.PI,h=.5+a/(Math.PI*2);e.push(o,h)}return e}}const xe=["ogv","webm","mp4"];var Y;(function(s){s[s.Data=0]="Data",s[s.Element=1]="Element",s[s.Url=2]="Url"})(Y||(Y={}));var X;(function(s){s.MipMap="mipmap",s.Linear="linear",s.Nearest="nearest"})(X||(X={}));function _e(s){return"data"in s&&"width"in s&&"height"in s}class N extends Bt{constructor(t,e,i,r={filtering:X.Linear},n){super(),this.valid=!1,this.dirty=!1,this.animated=!1,this.powerOf2=!1,this.key=e,this.index=i,this.options=r,this.workpath=n,this.create(t)}static isPowerOf2(t){return(t&t-1)===0}static isSafari(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}static isTextureUrl(t){return t&&/\.(jpg|jpeg|png|ogv|webm|mp4)$/i.test(t.split("?")[0])}static isTexture(t){return N.getTextureOptions(t)!==void 0}static getMaxTextureSize(t){return t.getParameter(t.MAX_TEXTURE_SIZE)}static getTextureOptions(t,e={}){if(typeof t=="string"&&t!==""){if(N.isTextureUrl(t))return e.url=t,t.indexOf("?")!==-1&&(e=t.split("?")[1].split("&").reduce(function(i,r){const n=r.split("="),a=decodeURIComponent(n[0]),o=decodeURIComponent(n[1]);switch(a){case"filtering":i[a]=o;break;case"repeat":case"UNPACK_FLIP_Y_WEBGL":i[a]=Boolean(o);break;case"UNPACK_PREMULTIPLY_ALPHA_WEBGL":case"TEXTURE_WRAP_S":case"TEXTURE_WRAP_T":i[a]=Number(o);break}return i},e)),e;document&&(t=document.querySelector(t))}return t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement?(e.element=t,e):_e(t)?(e.data=t.data,e.width=t.width,e.height=t.height,e):null}create(t){this.texture=t.createTexture(),this.texture&&(this.valid=!0),this.setData(t,1,1,new Uint8Array([0,0,0,0]),this.options)}load(t,e={}){return this.options=e,typeof e.url=="string"?this.url===void 0||e.url!==this.url?this.setUrl(t,e.url,e):Promise.resolve(this):e.element?this.setElement(t,e.element,e):e.data&&e.width&&e.height?this.setData(t,e.width,e.height,e.data,e):Promise.reject(this)}setUrl(t,e,i={}){if(!this.valid)return Promise.reject(this);this.url=e,this.source=e,this.sourceType=Y.Url,this.options=Object.assign(this.options,i);const r=e.split("?")[0].split(".").pop().toLowerCase(),n=xe.indexOf(r)!==-1,a=I.getResource(e,this.workpath);let o,h;return n?(U.log("GlslCanvas.setUrl video",a),o=document.createElement("video"),o.setAttribute("preload","auto"),o.setAttribute("loop","true"),o.setAttribute("muted","true"),o.setAttribute("playsinline","true"),o.loop=!0,o.muted=!0,h=this.setElement(t,o,i),o.src=a,o.addEventListener("canplay",()=>{o.play()})):(U.log("GlslCanvas.setUrl image",a),o=document.createElement("img"),h=this.setElement(t,o,i),N.isSafari()&&e.slice(0,5)==="data:"||(o.crossOrigin="anonymous"),o.src=a),h}setElement(t,e,i={}){return i=this.options=Object.assign(this.options,i),new Promise((r,n)=>{const a=e;if(typeof e=="string"&&(e=document.querySelector(e)),e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)if(this.source=e,this.sourceType=Y.Element,e instanceof HTMLVideoElement){const o=e;o.addEventListener("loadeddata",h=>{this.update(t,i),this.setFiltering(t,i),r(this)}),o.addEventListener("error",h=>{n(h)}),o.load()}else e instanceof HTMLImageElement?(e.addEventListener("load",()=>{this.update(t,i),this.setFiltering(t,i),r(this)}),e.addEventListener("error",o=>{n(o)})):(this.update(t,i),this.setFiltering(t,i),r(this));else{let o=`the 'element' parameter (\`element: ${JSON.stringify(a)}\`) must be a CSS selector string, or a <canvas>, <image> or <video> object`;U.log(`Texture '${this.key}': ${o}`,i),n(o)}})}setData(t,e,i,r,n={}){return this.width=e,this.height=i,this.options=Object.assign(this.options,n),this.source=r,this.sourceType=Y.Data,this.update(t,n),this.setFiltering(t,n),Promise.resolve(this)}update(t,e){if(!!this.valid){if(t.activeTexture(t.TEXTURE0+this.index),t.bindTexture(t.TEXTURE_2D,this.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.UNPACK_FLIP_Y_WEBGL===!1?0:1),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.UNPACK_PREMULTIPLY_ALPHA_WEBGL||0),this.sourceType===Y.Element)this.source instanceof HTMLImageElement&&this.source.naturalWidth&&this.source.naturalHeight?(this.width=this.source.naturalWidth,this.height=this.source.naturalHeight,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source)):this.source instanceof HTMLVideoElement&&this.source.videoWidth&&this.source.videoHeight?(this.width=this.source.videoWidth,this.height=this.source.videoHeight,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source)):this.source instanceof HTMLCanvasElement&&(this.width=this.source.width,this.height=this.source.height,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source));else if(this.sourceType===Y.Data){const i=this.source;t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,i)}this.trigger("loaded",this)}}tryUpdate(t){let e=!1;return this.animated&&(e=!0,this.update(t,this.options)),e}destroy(t){!this.valid||(t.deleteTexture(this.texture),this.texture=null,delete this.source,this.source=null,this.valid=!1)}setFiltering(t,e){if(!this.valid)return;const i=N.isPowerOf2(this.width)&&N.isPowerOf2(this.height);let r=e.filtering||X.MipMap,n=e.TEXTURE_WRAP_S||(e.repeat?t.REPEAT:t.CLAMP_TO_EDGE),a=e.TEXTURE_WRAP_T||(e.repeat?t.REPEAT:t.CLAMP_TO_EDGE);i||(r=r===X.MipMap?X.Linear:r,n=a=t.CLAMP_TO_EDGE,(e.repeat||e.TEXTURE_WRAP_S||e.TEXTURE_WRAP_T)&&U.warn(`GlslCanvas: cannot repeat texture ${e.url} cause is not power of 2.`)),this.powerOf2=i,this.filtering=r,t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,a),this.filtering===X.MipMap?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D)):this.filtering===X.Nearest?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)):this.filtering===X.Linear&&(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR))}}class Wt extends lt{constructor(){super(...arguments),this.count=0,this.dirty=!1,this.animated=!1}clean(){Object.keys(this.values).forEach(t=>{this.values[t].dirty=!1}),this.dirty=!1}createOrUpdate(t,e,i,r=0,n={},a){let o;const h=N.getTextureOptions(i,n);return o=this.get(e),o||(o=new N(t,e,r+this.count,h,a),this.count++,this.set(e,o)),h!==void 0?o.load(t,h).then(u=>{if(u.source instanceof HTMLVideoElement){const f=u.source;f.addEventListener("play",()=>{u.animated=!0,this.animated=!0}),f.addEventListener("pause",()=>{u.animated=!1,this.animated=this.reduce((c,m)=>c||m.animated,!1)}),f.addEventListener("seeked",()=>{u.update(t,u.options),this.dirty=!0})}return u}):Promise.resolve(o)}}var d;(function(s){s[s.Unknown=0]="Unknown",s.Uniform1i="uniform1i",s.Uniform2i="uniform2i",s.Uniform3i="uniform3i",s.Uniform4i="uniform4i",s.Uniform1f="uniform1f",s.Uniform2f="uniform2f",s.Uniform3f="uniform3f",s.Uniform4f="uniform4f",s.Uniform1iv="uniform1iv",s.Uniform2iv="uniform2iv",s.Uniform3iv="uniform3iv",s.Uniform4iv="uniform4iv",s.Uniform1fv="uniform1fv",s.Uniform2fv="uniform2fv",s.Uniform3fv="uniform3fv",s.Uniform4fv="uniform4fv",s.UniformMatrix2fv="uniformMatrix2fv",s.UniformMatrix3fv="uniformMatrix3fv",s.UniformMatrix4fv="uniformMatrix4fv"})(d||(d={}));var v;(function(s){s[s.Unknown=0]="Unknown",s[s.Float=1]="Float",s[s.Int=2]="Int",s[s.Bool=3]="Bool",s[s.Sampler2D=4]="Sampler2D",s[s.SamplerCube=5]="SamplerCube",s[s.Matrix2fv=6]="Matrix2fv",s[s.Matrix3fv=7]="Matrix3fv",s[s.Matrix4fv=8]="Matrix4fv"})(v||(v={}));const Ft=[d.Uniform1i,d.Uniform2i,d.Uniform3i,d.Uniform4i],Ut=[d.Uniform1f,d.Uniform2f,d.Uniform3f,d.Uniform4f],Rt=[d.Uniform1iv,d.Uniform2iv,d.Uniform3iv,d.Uniform4iv],St=[d.Uniform1fv,d.Uniform2fv,d.Uniform3fv,d.Uniform4fv];class it{constructor(t){switch(this.dirty=!0,t&&Object.assign(this,t),this.method){case d.UniformMatrix2fv:case d.UniformMatrix3fv:case d.UniformMatrix4fv:this.apply=(e,i)=>{if(this.dirty){e.useProgram(i);const r=e.getUniformLocation(i,this.key);e[this.method].apply(e,[r,!1].concat(this.values))}};break;default:this.apply=(e,i)=>{if(this.dirty){e.useProgram(i);const r=e.getUniformLocation(i,this.key);e[this.method].apply(e,[r].concat(this.values))}}}}}class Dt extends it{constructor(t){super(t)}}class z extends lt{constructor(){super(...arguments),this.dirty=!1}static isArrayOfInteger(t){return t.reduce((e,i)=>e&&Number.isInteger(i),!0)}static isArrayOfNumber(t){return t.reduce((e,i)=>e&&typeof i=="number",!0)}static isArrayOfBoolean(t){return t.reduce((e,i)=>e&&typeof i=="boolean",!0)}static isArrayOfTexture(t){return t.reduce((e,i)=>e&&N.isTexture(i),!0)}static isArrayOfSampler2D(t){return t.reduce((e,i)=>e&&i.type===v.Sampler2D,!0)}static getType_(t){let e=v.Unknown;const r=t.length===1&&Array.isArray(t[0])?t[0]:t;return z.isArrayOfNumber(r)?e=v.Float:z.isArrayOfBoolean(r)?e=v.Bool:z.isArrayOfTexture(r)&&(e=v.Sampler2D),e}static getMethod_(t,e){let i=d.Unknown;const r=e.length===1&&Array.isArray(e[0]),a=(r?e[0]:e).length,o=a-1;switch(t){case v.Float:r?i=o<St.length?St[o]:d.Unknown:i=o<Ut.length?Ut[o]:d.Uniform1fv;break;case v.Int:case v.Bool:r?i=o<Rt.length?Rt[o]:d.Unknown:i=o<Ft.length?Ft[o]:d.Uniform1iv;break;case v.Sampler2D:r?i=d.Uniform1iv:i=a===1?d.Uniform1i:d.Uniform1iv;break}return i}static parseUniform(t,e,i=null){let r;i=i||z.getType_(e);const n=z.getMethod_(i,e);if(i!==v.Unknown&&n!==d.Unknown){if(i===v.Sampler2D&&n===d.Uniform1iv)return e[0].map((a,o)=>new it({method:n,type:i,key:`${t}[${o}]`,values:[a]}));r=new it({method:n,type:i,key:t,values:e})}else U.error("Uniforms.parseUniform.Unknown",t,e);return r}create(t,e,i,r){const n=new it({method:t,type:e,key:i,values:r});return this.set(i,n),this.dirty=!0,n}createTexture(t,e){let i;return t.indexOf("]")!==-1?i=new Dt({method:d.Uniform1iv,type:v.Sampler2D,key:t,values:[[e]]}):i=new Dt({method:d.Uniform1i,type:v.Sampler2D,key:t,values:[e]}),this.set(t,i),this.dirty=!0,i}update(t,e,i,r){const n=this.get(i);n&&(n.method=t,n.type=e,n.values=r,n.dirty=!0,this.dirty=!0)}createOrUpdate(t,e,i,r){this.has(i)?this.update(t,e,i,r):this.create(t,e,i,r)}apply(t,e){t.useProgram(e),Object.keys(this.values).forEach(i=>{this.values[i].apply(t,e)})}clean(){Object.keys(this.values).forEach(t=>{this.values[t].dirty=!1}),this.dirty=!1}static isDifferent(t,e){return t.length!==e.length||t.reduce((i,r,n)=>i||r!==e[n],!1)}}class Ee extends Bt{constructor(){super(),this.uniforms=new z,this.buffers=new tt,this.textures=new Wt,this.textureList=[],this.W=0,this.H=0,this.mouse=new st,this.radians=0,this.dirty=!0,this.animated=!1,this.camera=new rt,this.cache={},this.drawFunc_=this.drawArrays_}render(){const t=this.gl;if(!t)return;const e=t.drawingBufferWidth,i=t.drawingBufferHeight;this.update_(),t.viewport(0,0,e,i);const r=this.uniforms;Object.keys(this.buffers.values).forEach(n=>{const a=this.buffers.values[n];a.geometry.attachAttributes_(t,a.program),r.apply(t,a.program),a.render(t,e,i)}),this.geometry.attachAttributes_(t,this.program),r.apply(t,this.program),this.drawFunc_(this.timer.delta),r.clean(),this.textures.clean(),this.dirty=!1,this.trigger("render",this)}drawArrays_(t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.W,this.H),e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),this.doubleSided&&this.mode!==S.Flat&&(e.cullFace(e.FRONT),e.drawArrays(e.TRIANGLES,0,this.geometry.size),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)),e.cullFace(e.BACK),e.drawArrays(e.TRIANGLES,0,this.geometry.size)}create_(){this.createGeometry_(),this.createUniforms_()}createGeometry_(){this.parseGeometry_(),this.setMode(this.mode)}parseGeometry_(){const e=/^attribute\s+vec4\s+a_position\s*;\s*\/\/\s*([\w|\:\/\/|\.|\-|\_|\?|\&|\=]+)/gm.exec(this.vertexString);e&&e.length>1?this.mesh=e[1]:this.mesh=this.defaultMesh}createUniforms_(){const t=this.gl,e=this.fragmentString,i=t.drawingBufferWidth,r=t.drawingBufferHeight,n=this.timer=new le,a=(e.match(/u_delta/g)||[]).length>1,o=(e.match(/u_time/g)||[]).length>1,h=(e.match(/u_date/g)||[]).length>1,u=(e.match(/u_mouse/g)||[]).length>1,f=(e.match(/u_camera/g)||[]).length>1;this.animated=!0;const c=this.uniforms;if(c.create(d.Uniform2f,v.Float,"u_resolution",[i,r]),a?(c.create(d.Uniform1f,v.Float,"u_delta",[n.delta/1e3]),this.updateUniformDelta_=this.updateUniformDelta__):this.updateUniformDelta_=this.updateUniformNoop_,o?(c.create(d.Uniform1f,v.Float,"u_time",[n.current/1e3]),this.updateUniformTime_=this.updateUniformTime__):this.updateUniformTime_=this.updateUniformNoop_,h){const m=new Date;c.create(d.Uniform4f,v.Float,"u_date",[m.getFullYear(),m.getMonth(),m.getDate(),m.getHours()*3600+m.getMinutes()*60+m.getSeconds()+m.getMilliseconds()*.001]),this.updateUniformDate_=this.updateUniformDate__}else this.updateUniformDate_=this.updateUniformNoop_;u?(c.create(d.Uniform2f,v.Float,"u_mouse",[0,0]),this.updateUniformMouse_=this.updateUniformMouse__):this.updateUniformMouse_=this.updateUniformNoop_,f?(c.create(d.Uniform3f,v.Float,"u_camera",[0,0,0]),this.updateUniformCamera_=this.updateUniformCamera__):this.updateUniformCamera_=this.updateUniformNoop_,this.projectionMatrix=q(),c.create(d.UniformMatrix4fv,v.Float,"u_projectionMatrix",this.projectionMatrix),this.modelViewMatrix=q(),c.create(d.UniformMatrix4fv,v.Float,"u_modelViewMatrix",this.modelViewMatrix),this.normalMatrix=q(),c.create(d.UniformMatrix4fv,v.Float,"u_normalMatrix",this.normalMatrix)}update_(){const t=this.gl,e=t.drawingBufferWidth,i=t.drawingBufferHeight;if(!this.timer)return;const r=this.timer.next();this.uniforms.update(d.Uniform2f,v.Float,"u_resolution",[e,i]),this.updateUniformDelta_(r),this.updateUniformTime_(r),this.updateUniformDate_(),this.updateUniformMouse_(),this.updateUniformCamera_(),this.updateUniformMesh_()}updateUniformNoop_(){}updateUniformDelta__(t){this.uniforms.update(d.Uniform1f,v.Float,"u_delta",[t.delta/1e3])}updateUniformTime__(t){this.uniforms.update(d.Uniform1f,v.Float,"u_time",[t.current/1e3])}updateUniformDate__(){const t=this.uniforms,e=new Date;t.update(d.Uniform4f,v.Float,"u_date",[e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()*3600+e.getMinutes()*60+e.getSeconds()+e.getMilliseconds()*.001])}updateUniformMouse__(){const t=this.uniforms,e=this.mouse;t.update(d.Uniform2f,v.Float,"u_mouse",[e.x,e.y])}updateUniformCamera__(){const t=this.uniforms,e=rt.toArray(this.camera);t.update(d.Uniform3f,v.Float,"u_camera",e)}updateUniformMesh__(){const t=this.uniforms;t.update(d.UniformMatrix4fv,v.Float,"u_projectionMatrix",this.updateProjectionMatrix_()),t.update(d.UniformMatrix4fv,v.Float,"u_modelViewMatrix",this.updateModelViewMatrix_(this.timer.delta)),t.update(d.UniformMatrix4fv,v.Float,"u_normalMatrix",this.updateNormalMatrix_(this.modelViewMatrix))}updateUniformFlat__(){const t=this.uniforms;t.update(d.UniformMatrix4fv,v.Float,"u_projectionMatrix",q()),t.update(d.UniformMatrix4fv,v.Float,"u_modelViewMatrix",q()),t.update(d.UniformMatrix4fv,v.Float,"u_normalMatrix",q())}updateProjectionMatrix_(){const t=this.gl,e=45*Math.PI/180,i=t.drawingBufferWidth/t.drawingBufferHeight,r=.1,n=100;return fe(this.projectionMatrix,e,i,r,n),this.projectionMatrix}updateModelViewMatrix_(t){const e=this.camera;let i=this.modelViewMatrix;return i=Mt(i),ue(i,i,[0,0,-e.radius]),wt(i,i,e.theta+this.radians,[0,1,0]),wt(i,i,e.phi,[1,0,0]),e.mouse||(e.theta+=(0-e.theta)/20,e.phi+=(0-e.phi)/20,this.radians+=t*5e-4),i}updateNormalMatrix_(t){let e=this.normalMatrix;return e=Mt(e),ce(e,t),he(e,e),e}setMode(t){let e;if(t===S.Mesh&&(e=this.cache[this.mesh],e)){this.geometry=e,this.mode=S.Mesh,this.updateUniformMesh_=this.updateUniformMesh__,this.dirty=!0;return}let i;switch(t){case S.Flat:e=new ct,this.updateUniformMesh_=this.updateUniformNoop_,this.updateUniformFlat__();break;case S.Box:e=new de,this.updateUniformMesh_=this.updateUniformMesh__;break;case S.Sphere:e=new me,this.updateUniformMesh_=this.updateUniformMesh__;break;case S.Torus:e=new ve,this.updateUniformMesh_=this.updateUniformMesh__;break;case S.Mesh:e=new ct,this.mesh?(i=new pe,i.load(I.getResource(this.mesh,this.workpath)).then(r=>{r.createAttributes_(this.gl,this.program);const n={};n[this.mesh]=r,this.cache=n,this.geometry=r,this.dirty=!0},r=>{U.warn("GlslCanvas",r),this.mode=S.Flat})):t=S.Flat,this.updateUniformMesh_=this.updateUniformMesh__;break}e.create(this.gl,this.program),this.geometry=e,this.mode=t,this.dirty=!0}setMesh(t){this.mesh=t}}class j extends Ee{constructor(t,e={}){super(),this.valid=!1,this.visible=!1,this.controls=!1,this.vertexPath="",this.fragmentPath="",t&&(this.options=e,this.canvas=t,this.width=0,this.height=0,this.rect=t.getBoundingClientRect(),this.devicePixelRatio=window.devicePixelRatio||1,this.mode=e.mode||S.Flat,this.mesh=e.mesh||void 0,this.doubleSided=e.doubleSided||!1,this.defaultMesh=this.mesh,this.workpath=e.workpath,t.style.backgroundColor=e.backgroundColor||"rgba(0,0,0,0)",this.getShaders_().then(i=>{this.load().then(r=>{!this.program||(this.addListeners_(),this.onLoop())})},i=>{U.error("GlslCanvas.getShaders_.error",i)}),j.items.push(this))}getShaders_(){return new Promise(t=>{this.vertexString=this.options.vertexString||this.vertexString,this.fragmentString=this.options.fragmentString||this.fragmentString;const e=this.canvas,i={};e.hasAttribute("data-vertex-url")&&(i.vertex=e.getAttribute("data-vertex-url")),e.hasAttribute("data-fragment-url")&&(i.fragment=e.getAttribute("data-fragment-url")),e.hasAttribute("data-vertex")&&(this.vertexString=e.getAttribute("data-vertex")),e.hasAttribute("data-fragment")&&(this.fragmentString=e.getAttribute("data-fragment")),Object.keys(i).length?Promise.all(Object.keys(i).map(r=>{const n=I.getResource(i[r],this.workpath);return I.fetch(n).then(a=>{const o=I.dirname(i[r]);return r==="vertex"?(this.vertexPath=o,this.vertexString=a):(this.fragmentPath=o,this.fragmentString=a)})})).then(r=>{t([this.vertexString,this.fragmentString])}):t([this.vertexString,this.fragmentString])})}addListeners_(){this.onScroll=this.onScroll.bind(this),this.onWheel=this.onWheel.bind(this),this.onClick=this.onClick.bind(this),this.onMove=this.onMove.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.onLoop=this.onLoop.bind(this),window.addEventListener("scroll",this.onScroll),document.addEventListener("mousemove",this.onMouseMove,!1),document.addEventListener("touchmove",this.onTouchMove),this.addCanvasListeners_()}addCanvasListeners_(){this.controls=this.canvas.hasAttribute("controls"),this.canvas.addEventListener("wheel",this.onWheel),this.canvas.addEventListener("click",this.onClick),this.canvas.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("touchstart",this.onTouchStart),this.controls&&(this.canvas.addEventListener("mouseover",this.onMouseOver),this.canvas.addEventListener("mouseout",this.onMouseOut),this.canvas.hasAttribute("data-autoplay")||this.pause())}removeCanvasListeners_(){this.canvas.removeEventListener("wheel",this.onWheel),this.canvas.removeEventListener("click",this.onClick),this.canvas.removeEventListener("mousedown",this.onMouseDown),this.canvas.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("touchstart",this.onTouchStart),this.canvas.removeEventListener("touchend",this.onTouchEnd),this.controls&&(this.canvas.removeEventListener("mouseover",this.onMouseOver),this.canvas.removeEventListener("mouseout",this.onMouseOut))}removeListeners_(){window.cancelAnimationFrame(this.rafId),window.removeEventListener("scroll",this.onScroll),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("touchmove",this.onTouchMove),this.removeCanvasListeners_()}onScroll(t){this.rect=this.canvas.getBoundingClientRect()}onWheel(t){this.camera.wheel(t.deltaY),this.dirty=this.mode!==S.Flat,this.trigger("wheel",t)}onClick(t){this.controls&&this.toggle(),this.trigger("click",t)}onDown(t,e){const i=this.rect;t=t-i.left,e=i.height-(e-i.top);const r=t*this.devicePixelRatio,n=e*this.devicePixelRatio;this.mouse.x=r,this.mouse.y=n;const a=Math.min(i.width,i.height);this.camera.down(t/a,e/a),this.trigger("down",this.mouse)}onMove(t,e){const i=this.rect;t=t-i.left,e=i.height-(e-i.top);const r=t*this.devicePixelRatio,n=e*this.devicePixelRatio;if(r!==this.mouse.x||n!==this.mouse.y){this.mouse.x=r,this.mouse.y=n;const a=Math.min(i.width,i.height);this.camera.move(t/a,e/a),this.dirty=this.mode!==S.Flat&&this.camera.mouse!==null,this.trigger("move",this.mouse)}}onUp(t){this.camera.up(),this.controls&&this.pause(),this.trigger("out",t)}onMouseDown(t){this.onDown(t.clientX,t.clientY),document.addEventListener("mouseup",this.onMouseUp),document.removeEventListener("touchstart",this.onTouchStart),document.removeEventListener("touchmove",this.onTouchMove)}onMouseMove(t){this.onMove(t.clientX,t.clientY)}onMouseUp(t){this.onUp(t)}onMouseOver(t){this.play(),this.trigger("over",t)}onMouseOut(t){this.pause(),this.trigger("out",t)}onTouchStart(t){const e=[].slice.call(t.touches).reduce((i,r)=>(i=i||new st,i.x+=r.clientX,i.y+=r.clientY,i),null);e&&this.onDown(e.x/t.touches.length,e.y/t.touches.length),this.controls&&this.play(),this.trigger("over",t),document.addEventListener("touchend",this.onTouchEnd),document.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mousemove",this.onMouseMove),this.controls&&(this.canvas.removeEventListener("mouseover",this.onMouseOver),this.canvas.removeEventListener("mouseout",this.onMouseOut))}onTouchMove(t){const e=[].slice.call(t.touches).reduce((i,r)=>(i=i||new st,i.x+=r.clientX,i.y+=r.clientY,i),null);e&&this.onMove(e.x/t.touches.length,e.y/t.touches.length)}onTouchEnd(t){this.onUp(t),document.removeEventListener("touchend",this.onTouchEnd)}onLoop(t){this.checkRender(),this.rafId=window.requestAnimationFrame(this.onLoop)}setUniform_(t,e,i={},r=null){const n=z.parseUniform(t,e,r);if(Array.isArray(n))z.isArrayOfSampler2D(n)?n.forEach(a=>this.loadTexture(a.key,a.values[0],i)):n.forEach(a=>this.uniforms.set(a.key,a.values[0]));else if(n)switch(n.type){case v.Sampler2D:this.loadTexture(t,e[0],i);break;default:this.uniforms.set(t,n)}}isVisible_(){const t=this.rect;return t.top+t.height>0&&t.top<(window.innerHeight||document.documentElement.clientHeight)}isAnimated_(){return(this.animated||this.textures.animated||this.mode!==S.Flat)&&!this.timer.paused}isDirty_(){return this.dirty||this.uniforms.dirty||this.textures.dirty}sizeDidChanged_(){const t=this.gl,e=Math.ceil(this.canvas.clientWidth),i=Math.ceil(this.canvas.clientHeight);if(this.width!==e||this.height!==i){this.width=e,this.height=i;const r=Math.ceil(e*this.devicePixelRatio),n=Math.ceil(i*this.devicePixelRatio);return this.W=r,this.H=n,this.canvas.width=r,this.canvas.height=n,Object.keys(this.buffers.values).forEach(a=>{this.buffers.values[a].resize(t,r,n)}),this.rect=this.canvas.getBoundingClientRect(),this.trigger("resize"),!0}else return!1}parseTextures_(t){const e=/uniform\s*sampler2D\s*([\w]*);(\s*\/\/\s*([\w|\:\/\/|\.|\-|\_|\?|\&|\=]*)|\s*)/gm;let i;for(;(i=e.exec(t))!==null;){const r=i[1],n=i[3];N.isTextureUrl(n)?this.textureList.push({key:r,url:n}):this.buffers.has(r)||this.textureList.push({key:r,url:null})}return this.canvas.hasAttribute("data-textures")&&this.canvas.getAttribute("data-textures").split(",").forEach((n,a)=>{const o="u_texture"+a;this.textureList.push({key:o,url:n})}),this.textureList.length>0}load(t,e){const i=p.getFragmentVertex(this.gl,t||this.fragmentString);return Promise.all([p.getIncludes(t||this.fragmentString,this.fragmentPath===""?this.workpath:this.fragmentPath),p.getIncludes(i||e||this.vertexString,this.vertexPath===""?this.workpath:this.vertexPath)]).then(r=>(this.fragmentString=r[0],this.vertexString=r[1],this.createContext_()))}getContext_(){const t=this.vertexString,e=this.fragmentString;if(this.vertexString=p.getVertex(t,e,this.mode),this.fragmentString=p.getFragment(t,e,this.mode),p.versionDiffers(this.gl,t,e)&&(this.destroyContext_(),this.swapCanvas_(),this.uniforms=new z,this.buffers=new tt,this.textures=new Wt,this.textureList=[]),!this.gl){const i=p.tryInferContext(t,e,this.canvas,this.options,this.options.extensions,this.options.onError);if(!i)return null;this.gl=i}return this.gl}createContext_(){const t=this.getContext_();if(!t)return!1;let e,i;try{if(p.inferPrecision(this.fragmentString),e=p.createShader(t,this.vertexString,t.VERTEX_SHADER),i=p.createShader(t,this.fragmentString,t.FRAGMENT_SHADER),i)this.valid=!0;else{const n=p.getFragment(null,null,this.mode);i=p.createShader(t,n,t.FRAGMENT_SHADER),this.valid=!1}}catch(n){return this.trigger("error",n),!1}const r=p.createProgram(t,[e,i]);if(!r)return this.trigger("error",p.lastError),!1;if(t.deleteShader(e),t.deleteShader(i),this.program=r,this.valid){try{this.buffers=tt.getBuffers(t,this.fragmentString,p.getBufferVertex(t))}catch(n){return this.valid=!1,this.trigger("error",n),!1}this.create_(),this.animated?this.canvas.classList.add("animated"):this.canvas.classList.remove("animated")}return this.trigger("load",this),this.valid}create_(){this.parseMode_(),this.parseMesh_(),super.create_(),this.createBuffers_(),this.createTextures_()}parseMode_(){if(this.canvas.hasAttribute("data-mode")){const t=this.canvas.getAttribute("data-mode");["flat","box","sphere","torus","mesh"].indexOf(t)!==-1&&(this.mode=t)}}parseMesh_(){if(this.canvas.hasAttribute("data-mesh")){const t=this.canvas.getAttribute("data-mesh");t.indexOf(".obj")!==-1&&(this.mesh=this.defaultMesh=t)}}createBuffers_(){Object.keys(this.buffers.values).forEach(t=>{const e=this.buffers.values[t];this.uniforms.create(d.Uniform1i,v.Sampler2D,e.key,[e.input.index])})}createTextures_(){this.parseTextures_(this.fragmentString)&&(this.textureList.filter(e=>e.url).forEach(e=>{this.setTexture(e.key,e.url,e.options)}),this.textureList=[])}update_(){super.update_(),this.updateBuffers_(),this.updateTextures_()}updateBuffers_(){Object.keys(this.buffers.values).forEach(t=>{const e=this.buffers.values[t];this.uniforms.update(d.Uniform1i,v.Sampler2D,e.key,[e.input.index])})}updateTextures_(){const t=this.gl;Object.keys(this.textures.values).forEach(e=>{const i=this.textures.values[e];i.tryUpdate(t),this.uniforms.update(d.Uniform1i,v.Sampler2D,i.key,[i.index])})}destroyContext_(){const t=this.gl;t.useProgram(null),this.program&&t.deleteProgram(this.program),Object.keys(this.buffers.values).forEach(e=>{this.buffers.values[e].destroy(t)}),Object.keys(this.textures.values).forEach(e=>{this.textures.values[e].destroy(t)}),this.buffers=null,this.textures=null,this.uniforms=null,this.program=null,this.gl=null}swapCanvas_(){const t=this.canvas,e=t.cloneNode();t.parentNode.replaceChild(e,t),this.canvas=e,this.addCanvasListeners_()}destroy(){this.removeListeners_(),this.destroyContext_(),this.animated=!1,this.valid=!1;const t=j.items.indexOf(this);t!==-1&&j.items.splice(t,1)}loadTexture(t,e,i={}){this.valid?this.textures.createOrUpdate(this.gl,t,e,this.buffers.count,i,this.options.workpath).then(r=>{const n=r.index,a=this.uniforms.createTexture(t,n);a.texture=r;const o=t.indexOf("[")!==-1?t.replace("[","Resolution["):t+"Resolution";return this.uniforms.create(d.Uniform2f,v.Float,o,[r.width,r.height]),r},r=>{const n=Array.isArray(r.path)?r.path.map(a=>a.error?a.error.message:"").join(", "):r.message;U.error("GlslCanvas.loadTexture.error",t,e,n),this.trigger("textureError",{key:t,urlElementOrData:e,message:n})}):this.textureList.push({key:t,url:e,options:i})}setTexture(t,e,i={}){return this.setUniform_(t,[e],i)}setUniform(t,...e){return this.setUniform_(t,e)}setUniformOfInt(t,e){return this.setUniform_(t,e,null,v.Int)}setUniforms(t){Object.keys(t).forEach(e=>{this.setUniform(e,t[e])})}pause(){this.valid&&(this.timer.pause(),this.canvas.classList.add("paused"),this.trigger("pause"))}play(){this.valid&&(this.timer.play(),this.canvas.classList.remove("paused"),this.trigger("play"))}toggle(){this.valid&&(this.timer.paused?this.play():this.pause())}checkRender(){this.isVisible_()&&(this.sizeDidChanged_()||this.isDirty_()||this.isAnimated_())?(this.render(),this.canvas.classList.add("playing")):this.canvas.classList.remove("playing")}}j.items=[];function be(s,t){return j.items.find(e=>e.canvas===s)||new j(s,t)}function Te(){return[].slice.call(document.getElementsByClassName("glsl-canvas")).filter(t=>t instanceof HTMLCanvasElement).map(t=>be(t))}typeof window=="object"&&document.addEventListener("DOMContentLoaded",()=>{Te()});const J=class extends j{static extend(t,e,i){return!i&&t.includes(e)?t:t.startsWith(this.v3pragma)?`${this.v3pragma}${e}${t.slice(this.v3pragma.length)}`:e+t}static extendMain(t,e,i){if(!i&&t.includes(e))return t;let r=t.indexOf("void main() {");return r===-1?t:(r+=13,`${t.slice(0,r)}${e}${t.slice(r)}`)}constructor(t,n={}){var a=n,{fragmentString:e,vertexString:i}=a,r=xt(a,["fragmentString","vertexString"]);typeof i=="string"&&(i=J.extend(i,"precision highp float;")),typeof e=="string"&&(e=J.extend(e,"precision highp float;")),super(t,pt(vt({},r),{vertexString:i,fragmentString:e})),zt(()=>this.destroy())}load(t,e){return typeof e=="string"&&(e=J.extend(e,"precision highp float;")),typeof t=="string"&&(t=J.extend(t,"precision highp float;")),super.load(t,e)}useUniform(t,e){return Et(()=>{const{value:i}=e;Array.isArray(i)?this.setUniform(t,...i):this.setUniform(t,i)})}useUniformOfInt(t,e){return Et(()=>{const{value:i}=e;Array.isArray(i)?this.setUniformOfInt(t,i):this.setUniformOfInt(t,[i])})}};let at=J;_t(at,"v3pragma",`#version 300 es
`);export{at as W};
