import{readFile as Y}from"node:fs";import{Server as W}from"node:http";import{Server as J}from"socket.io";import{compare as F,hash as j}from"bcrypt";import{randomUUID as b}from"crypto";import{MongoClient as z}from"mongodb";var y=process.env.ZSNOUT_DATABASE?new z(process.env.ZSNOUT_DATABASE,{serverApi:"1"}).connect().then(e=>(e.on("error",async()=>{await e.close(),await e.connect()}),e)).catch(e=>(console.log(e),void 0)):Promise.resolve((console.log("no database available"),void 0)),B=y.then(e=>e==null?void 0:e.db("zsnout")).catch(e=>(console.log(e),void 0)),X=y.then(e=>!!e)??Promise.resolve(!1);async function w(e){var t;return(t=await B)==null?void 0:t.collection(e)}process.on("beforeExit",()=>{y.then(e=>e==null?void 0:e.close())});import{createTransport as C}from"nodemailer";var E={host:process.env.ZSNOUT_MAIL_HOST,port:+(process.env.ZSNOUT_MAIL_PORT||587),secure:process.env.ZSNOUT_MAIL_PORT==="465",auth:{user:process.env.ZSNOUT_MAIL_USER,pass:process.env.ZSNOUT_MAIL_PASSWORD}},te=!!(process.env.ZSNOUT_MAIL_HOST&&process.env.ZSNOUT_MAIL_USER&&process.env.ZSNOUT_MAIL_PASSWORD),d=C(E);function x(e){return new Promise(t=>{d==null||d.sendMail({...e,from:process.env.ZSNOUT_MAIL_FROM},(s,n)=>{s?(console.log(s),t(void 0)):t(n)})})}process.on("beforeExit",()=>d==null?void 0:d.close());var h;(n=>{function e(o){return o.length>=5&&o.length<=20&&/^[A-Za-z_][A-Za-z0-9_]+$/.test(o)&&!/zsnout/i.test(o)}n.Username=e;function t(o){return o.length>=8&&/(?![\d_])\w/.test(o)&&/\d/.test(o)&&/[^\s\w]/.test(o)}n.Password=t;function s(o){return/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(o)}n.Email=s})(h||={});function H(e){return j(e,10)}function L(e,t){return F(e,t)}var u=w("accounts");async function _(e,t){let s=await u;if(!s)return{status:f.NoServer};let n=await s.findOne({username:e});return n?await L(t,n.password)?{status:f.Success,account:n}:{status:f.BadPassword}:{status:f.NoUser}}var f=(o=>(o[o.BadPassword=0]="BadPassword",o[o.NoServer=1]="NoServer",o[o.NoUser=2]="NoUser",o[o.Success=3]="Success",o))(f||{});async function m(e){let t=await u;if(!t)return{status:l.NoServer};let s=await t.findOne({session:e});return s?{status:l.Success,account:s}:{status:l.Failure}}var l=(n=>(n[n.Failure=0]="Failure",n[n.NoServer=1]="NoServer",n[n.Success=2]="Success",n))(l||{});async function P(e,t,s){let n=await u;if(!n)return{status:c.NoServer};if(!h.Username(e))return{status:c.BadUsername};if(!h.Password(t))return{status:c.BadPassword};if(!h.Email(s))return{status:c.BadEmail};if(await k(),await n.findOne({username:e}))return{status:c.UsernameTaken};if(await n.findOne({email:s}))return{status:c.EmailTaken};let o={username:e,password:await H(t),email:s,creation:Date.now(),session:b(),verified:!1,verifyCode:b(),bookmarks:[],favoriteNotes:[],notes:[],favoriteChats:[],chats:[]};return(await n.insertOne(o)).acknowledged?await x({to:s,subject:"Verify your zSnout account",text:`Hey @${e}! Verify your new zSnout account by opening this link: https://zsnout.com/account/verify?code=${o.verifyCode}.`})?{status:c.Success,account:o}:(await n.deleteOne({session:o.session}),{status:c.BadEmail}):{status:c.Failure}}var c=(a=>(a[a.BadUsername=0]="BadUsername",a[a.BadPassword=1]="BadPassword",a[a.BadEmail=2]="BadEmail",a[a.EmailTaken=3]="EmailTaken",a[a.Failure=4]="Failure",a[a.NoServer=5]="NoServer",a[a.Success=6]="Success",a[a.UsernameTaken=7]="UsernameTaken",a))(c||{});async function U(e){let t=await u;if(!t)return{status:p.NoServer};let s=await t.findOneAndUpdate({verifyCode:e},{$set:{verified:!0}});return s.value?{status:p.Success,account:s.value}:{status:p.NoAccount}}var p=(n=>(n[n.NoAccount=0]="NoAccount",n[n.NoServer=1]="NoServer",n[n.Success=2]="Success",n))(p||{});async function k(){let e=await u;await(e==null?void 0:e.deleteMany({verified:!1,creation:{$lte:Date.now()-15*60*1e3}}))}async function M(e){var t;return await((t=await u)==null?void 0:t.findOne({session:e}))||void 0}async function $(e,t){var s,n;return(n=await((s=await u)==null?void 0:s.updateOne({session:e},{$set:t})))==null?void 0:n.acknowledged}setInterval(k,5*60*1e3);import{ObjectId as O}from"bson/lib/bson.js";var q=w("accounts"),v=w("notes");async function R(e,t){let s=await q;!s||await s.updateOne({_id:t},{$push:{notes:e}})}async function S(e){let{status:t,account:s}=await m(e);if(t===0)return[];if(t===1)return[];let n=await v;return n?(await n.find({_id:{$in:s.notes}}).toArray()).map(({_id:i,title:N,contents:D})=>({id:i.toHexString(),title:N,desc:D.slice(0,80).replaceAll(`
`," ")})):[]}async function I(e,t){let{status:s,account:n}=await m(e);if(s===0||s===1)return;let o=await v;if(!o||n.notes.length>=100)return;let i={_id:new O,contents:"<p>This is your new note!</p>",creation:Date.now(),owner:n._id,title:t};await Promise.all([o.insertOne(i),R(i._id,n._id)])}async function g(e,t){let{status:s,account:n}=await m(e);if(s===0)return{doesOwn:!1};if(s===1)return{doesOwn:!1};let o=await v;if(!o)return{doesOwn:!1};let i=await o.findOne({_id:O.createFromHexString(t),owner:n._id});return i?{doesOwn:!0,note:i}:{doesOwn:!1}}async function Z(e,t){if(t.length>=1e4)return;let s=await v;!s||await s.updateOne({_id:O.createFromHexString(e)},{$set:{contents:t}})}async function A(e,t){if(t.length>=100)return;let s=await v;!s||await s.updateOne({_id:O.createFromHexString(e)},{$set:{title:t}})}async function r(e,t){let{status:s,account:n}=await m(t);if(s===2){let o=n.creation+9e5;return(n.verified||!n.verified&&o>Date.now())&&(e.emit("account:update:session",n.session),e.emit("account:update:username",n.username)),n.verified?e.emit("account:needs-verification",!1):e.emit("account:needs-verification",o-Date.now()),e.data.oldSession&&e.leave(`session:${e.data.oldSession}`),e.join(`session:${e.data.oldSession=t}`),!0}else return e.emit("account:update:session",""),e.emit("account:update:username",""),e.emit("account:needs-verification",!1),e.data.oldSession&&e.leave(`session:${e.data.oldSession}`),!1}var T={"account:check-session"(e){r(this,e)},async"account:create"(e,t,s){let{status:n,account:o}=await P(e,t,s);n===6?(await r(this,o.session),this.emit("account:complete-login")):this.emit("error",{[2]:"Your email address is invalid. Make sure it is formatted properly and can recieve emails.",[1]:"Your password should have a letter, number, symbol, and be at least 8 characters long.",[0]:"Your username should only contain letters, numbers, and underscores, and should be at least 6 characters long.",[3]:`${s} is already registered with another account.`,[4]:"An unknown issue occurred. Try again later.",[5]:"This instance of zSnout can't log in users.",[7]:`@${e} is already registered with another account.`}[n])},async"account:login"(e,t){let{status:s,account:n}=await _(e,t);s===3?(await r(this,n.session),this.emit("account:complete-login")):this.emit("error",{[0]:"Your username or password is incorrect.",[1]:"This instance of zSnout can't log in users.",[2]:"Your username or password is incorrect."}[s])},async"account:verify"(e){let{status:t,account:s}=await U(e);t===2?(await r(this,s.session),this.emit("account:complete-login")):this.emit("error",{[0]:"The provided verification code is invalid.",[1]:"This instance of zSnout can't verify accounts."}[t])},async"bookmarks:request"(e){var t;if(await r(this,e)){let s=(t=await M(e))==null?void 0:t.bookmarks;s&&this.emit("bookmarks:list",s)}},async"bookmarks:update"(e,t){await r(this,e)&&await $(e,{bookmarks:t})&&t&&this.to(`session:${e}`).emit("bookmarks:list",t)},async"notes:create"(e,t){await r(this,e)?(await I(e,t),this.emit("notes:index",await S(e))):this.emit("notes:index",[])},async"notes:request:details"(e,t){if(await r(this,e)){let{doesOwn:s,note:n}=await g(e,t);s&&this.emit("notes:details",{id:t,title:n.title})}},async"notes:request:index"(e){await r(this,e)?this.emit("notes:index",await S(e)):this.emit("notes:index",[])},async"notes:request:note"(e,t){if(await r(this,e)){let{doesOwn:s,note:n}=await g(e,t);s?this.emit("notes:note",t,n.contents):this.emit("notes:note",t,!1)}},async"notes:update:note"(e,t,s){if(await r(this,e)){let{doesOwn:n}=await g(e,t);n&&(Z(t,s),this.to(`session:${e}`).emit("notes:note",t,s))}},async"notes:update:title"(e,t,s){if(await r(this,e)){let{doesOwn:n}=await g(e,t);n&&(await A(t,s),this.to(`session:${e}`).emit("notes:details",{id:t,title:s}))}}};Object.setPrototypeOf(T,null);function G(e){new J(e).on("connection",s=>{for(let n in T)s.on(n,T[n].bind(s))})}function ye(){let e=new W;G(e),e.addListener("request",(s,n)=>{Y("./index.html",(o,i)=>{n.headersSent||(o?(n.statusCode=503,n.setHeader("content-type","application/json").end(JSON.stringify(i))):n.setHeader("content-type","text/html").end(i))})});let t=+(process.env.PORT||3e3);e.listen(Number.isSafeInteger(t)?t:3e3)}export{G as makeIO,ye as start};
