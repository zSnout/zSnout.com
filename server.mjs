import{readFile as A}from"node:fs";import{Server as E}from"node:http";import{Server as $}from"socket.io";import{compare as Z,hash as I}from"bcrypt";import{randomUUID as S}from"crypto";import{MongoClient as k}from"mongodb";var v=process.env.ZSNOUT_DATABASE?new k(process.env.ZSNOUT_DATABASE,{serverApi:"1"}).connect().then(e=>(e.on("error",async()=>{await e.close(),await e.connect()}),e)).catch(e=>(console.log(e),void 0)):Promise.resolve((console.log("no database available"),void 0)),_=v.then(e=>e==null?void 0:e.db("zsnout")).catch(e=>(console.log(e),void 0)),F=v.then(e=>!!e)??Promise.resolve(!1);async function g(e){var s;return(s=await _)==null?void 0:s.collection(e)}process.on("beforeExit",()=>{v.then(e=>e==null?void 0:e.close())});import{createTransport as P}from"nodemailer";var M={host:process.env.ZSNOUT_MAIL_HOST,port:+(process.env.ZSNOUT_MAIL_PORT||587),secure:process.env.ZSNOUT_MAIL_PORT==="465",auth:{user:process.env.ZSNOUT_MAIL_USER,pass:process.env.ZSNOUT_MAIL_PASSWORD}},j=!!(process.env.ZSNOUT_MAIL_HOST&&process.env.ZSNOUT_MAIL_USER&&process.env.ZSNOUT_MAIL_PASSWORD),c=P(M);function T(e){return new Promise(s=>{c==null||c.sendMail({...e,from:process.env.ZSNOUT_MAIL_FROM},(t,n)=>{t?(console.log(t),s(void 0)):s(n)})})}process.on("beforeExit",()=>c==null?void 0:c.close());var m;(n=>{function e(o){return o.length>=5&&o.length<=20&&/^[A-Za-z_][A-Za-z0-9_]+$/.test(o)&&!/zsnout/i.test(o)}n.Username=e;function s(o){return o.length>=8&&/(?![\d_])\w/.test(o)&&/\d/.test(o)&&/[^\s\w]/.test(o)}n.Password=s;function t(o){return/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(o)}n.Email=t})(m||={});function z(e){return I(e,10)}function B(e,s){return Z(e,s)}var i=g("accounts");async function y(e,s){let t=await i;if(!t)return{status:u.NoServer};let n=await t.findOne({username:e});return n?await B(s,n.password)?{status:u.Success,account:n}:{status:u.BadPassword}:{status:u.NoUser}}var u=(o=>(o[o.BadPassword=0]="BadPassword",o[o.NoServer=1]="NoServer",o[o.NoUser=2]="NoUser",o[o.Success=3]="Success",o))(u||{});async function h(e){let s=await i;if(!s)return{status:l.NoServer};let t=await s.findOne({session:e});return t?{status:l.Success,account:t}:{status:l.Failure}}var l=(n=>(n[n.Failure=0]="Failure",n[n.NoServer=1]="NoServer",n[n.Success=2]="Success",n))(l||{});async function O(e,s,t){let n=await i;if(!n)return{status:a.NoServer};if(!m.Username(e))return{status:a.BadUsername};if(!m.Password(s))return{status:a.BadPassword};if(!m.Email(t))return{status:a.BadEmail};if(await N(),await n.findOne({username:e}))return{status:a.UsernameTaken};if(await n.findOne({email:t}))return{status:a.EmailTaken};let o={username:e,password:await z(s),email:t,creation:Date.now(),session:S(),verified:!1,verifyCode:S(),bookmarks:[]};return(await n.insertOne(o)).acknowledged?await T({to:t,subject:"Verify your zSnout account",text:`Hey @${e}! Verify your new zSnout account by opening this link: https://zsnout.com/account/verify?code=${o.verifyCode}.`})?{status:a.Success,account:o}:(await n.deleteOne({session:o.session}),{status:a.BadEmail}):{status:a.Failure}}var a=(r=>(r[r.BadUsername=0]="BadUsername",r[r.BadPassword=1]="BadPassword",r[r.BadEmail=2]="BadEmail",r[r.EmailTaken=3]="EmailTaken",r[r.Failure=4]="Failure",r[r.NoServer=5]="NoServer",r[r.Success=6]="Success",r[r.UsernameTaken=7]="UsernameTaken",r))(a||{});async function x(e){let s=await i;if(!s)return{status:f.NoServer};let t=await s.findOneAndUpdate({verifyCode:e},{$set:{verified:!0}});return t.value?{status:f.Success,account:t.value}:{status:f.NoAccount}}var f=(n=>(n[n.NoAccount=0]="NoAccount",n[n.NoServer=1]="NoServer",n[n.Success=2]="Success",n))(f||{});async function N(){let e=await i;await(e==null?void 0:e.deleteMany({verified:!1,creation:{$lte:Date.now()-15*60*1e3}}))}async function b(e){var s;return await((s=await i)==null?void 0:s.findOne({session:e}))||void 0}async function U(e,s){var t,n;return(n=await((t=await i)==null?void 0:t.updateOne({session:e},{$set:s})))==null?void 0:n.acknowledged}setInterval(N,5*60*1e3);async function d(e,s){let{status:t,account:n}=await h(s);return t===2?(e.emit("account:update:session",n.session),e.emit("account:update:username",n.username),e.oldSession&&e.leave(`session:${e.oldSession}`),e.join(`session:${e.oldSession=s}`),!0):(e.emit("account:update:session",""),e.emit("account:update:username",""),e.oldSession&&e.leave(`session:${e.oldSession}`),!1)}var w={"account:check-session"(e){d(this,e)},async"account:create"(e,s,t){let{status:n,account:o}=await O(e,s,t);n===6?(await d(this,o.session),this.emit("account:complete-login")):this.emit("error",{[2]:"Your email address is invalid. Make sure it is formatted properly and can recieve emails.",[1]:"Your password should have a letter, number, symbol, and be at least 8 characters long.",[0]:"Your username should only contain letters, numbers, and underscores, and should be at least 6 characters long.",[3]:`${t} is already registered with another account.`,[4]:"An unknown issue occurred. Try again later.",[5]:"This instance of zSnout can't log in users.",[7]:`@${e} is already registered with another account.`}[n])},async"account:login"(e,s){let{status:t,account:n}=await y(e,s);t===3?(await d(this,n.session),this.emit("account:complete-login")):this.emit("error",{[0]:"Your username or password is incorrect.",[1]:"This instance of zSnout can't log in users.",[2]:"Your username or password is incorrect."}[t])},async"account:verify"(e){let{status:s,account:t}=await x(e);s===2?(await d(this,t.session),this.emit("account:complete-login")):this.emit("error",{[0]:"The provided verification code is invalid.",[1]:"This instance of zSnout can't verify accounts."}[s])},async"bookmarks:request"(e){var s;if(await d(this,e)){let t=(s=await b(e))==null?void 0:s.bookmarks;t&&this.emit("bookmarks:list",t)}},async"bookmarks:update"(e,s){await d(this,e)&&await U(e,{bookmarks:s})&&s&&this.to(`session:${e}`).emit("bookmarks:list",s)}};Object.setPrototypeOf(w,null);function C(e){new $(e).on("connection",t=>{for(let n in w)t.on(n,w[n].bind(t))})}function te(){let e=new E;C(e),e.addListener("request",(t,n)=>{A("./index.html",(o,p)=>{o?(n.statusCode=503,n.setHeader("content-type","application/json").end(JSON.stringify(p))):n.setHeader("content-type","text/html").end(p)})});let s=+(process.env.PORT||3e3);e.listen(Number.isSafeInteger(s)?s:3e3)}export{C as makeIO,te as start};
